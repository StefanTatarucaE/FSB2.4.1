# Storage account key management parent module

Azure Bicep parent module to deploy the Storage accounts key management Key Vault and role assignment policy, part of the (optional) Automatic Key Rotation for storage accounts solution.

## Description

This parent module deploys a key vault resource that will manage the storage account keys for the storage accounts tagged with `EvidenManaged = true` and `EvidenKeyManagement = true` and also a DINE policy that will assign the Storage Account Key Operator Service Role (81a9662b-bebf-436f-a333-f67b29880f12) to the Microsoft Key Vault Enterprise Application, scoped to the target storage accounts.

The module calls the following child modules:
- Key Vault (childModules/keyVault/keyVault.bicep)
- Key Vault Access Policy (childModules/keyVaultAccessPolicy/keyVaultAccessPolicy.bicep)
- Key Management Role Assignment Policy (childModules/policy/storageAccountRoleAssignmentChange/policy.bicep)

### Naming convention module 

The names used by the deployment are generated by the naming helper module, in a powershell script called before this module deployment is started. The deployment of this solution is optional therefore it is done outside of the GitHub workflow for landing zones.

## Parent module overview

The parent module creates the following resources:

- A resource group for the resource(s).
- A Key Vault resource tagged with EvidenManaged = True and EvidenPurpose = EvidenStorageAccountKeyManagement.
- A key Vault Access Policy that grants the Storage permissions to the Management automation account Managed Identity.
- A DINE policy and policy assignment that grants the Storage Account Key Operator Service Role (81a9662b-bebf-436f-a333-f67b29880f12) to the tenant specific Microsoft Key Vault Enterprise Application.

The deployment is initiated by a powershell script (...\scripts\Deploy-StorageAccountKeyManagement.ps1).
This script checks and uploads the runbooks dedicated to this solution (Create-RemediationTaskStorageAccountRoleAssignment.ps1, Set-StorageAccountKeyVaultManagement.ps1) to the management Automation Account and initiates the parent module deployment for the specified landing zone subscription.
The Deploy-StorageAccountKeyManagement.ps1 script must be run on each landing zone subscription where the storage account key management option is required.

### Parent module parameters

**Required parameters**

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `location` | `string` | Specifies the location for deployment. |
| `subscriptionType` | `string` | Specifies the subscription type (for compatibility reasons) must always be `lndz`. |
| `keyVaultAppObjectId` | `string` | Specifies the object id of the Microsoft Key Vault Enterprise application from the tenant. For more information on this check [here](https://learn.microsoft.com/en-us/azure/key-vault/secrets/overview-storage-keys-powershell) for more information. |
| `automationAccountIdentity` | `string` | Specifies the Management Automation Account identity. |


**Optional parameters**

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `keyManagementTags` | `object` | `{}` | A mapping of additional tags to be assigned to the Key Vault resource and its parent resource group. |


## Example parameters file

The required values for parameters are described in the following example of a parameters file.
The values for the **required** parameters **must** be defined for the parent module to run successfully.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "value": "westeurope"
    },
    "subscriptionType": {
      "value": "lndz"
    },
    "keyVaultAppObjectId": {
      "value": "9c448bb3-fcfb-44be-8a74-f8c71939ff6e"
    },
    "keyManagementTags": {
      "value": {
        "EvidenManaged": "true"
      }
    },
    "automationAccountIdentity": {
      "value": "3e68a52b-72af-469c-b8db-a64dd23d25aa"
    }
  }
}
```

## ELZ Azure Configuration Values

The folder of the parent module contains a `parentModuleConfig.json` file. This json file contains the recommended values for some additional parameters required by the child modules this parent module is calling.

The `parentModuleConfig.json` file is referenced by the parent module in a 'parentModuleConfig' variable; `var parentModuleConfig = loadJsonContent('parentModuleConfig.json')`.

Description of the configuration defaults:

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `keyManagementKeyVaultFeatures` | `object` | `"enabledForDeployment": false, "enabledForDiskEncryption": false, "enabledForTemplateDeployment": false, "enablePurgeProtection": true, "enableRbacAuthorization": false, "enableSoftDelete": true` | Features of the Storage Account Key Managing Key Vault. |
| `keyManagementKeyVaultConfig` | `object` | `"skuName": "standard","publicNetworkAccess": "enabled","networkRuleBypassOptions": "AzureServices","networkRuleAction": "Allow","softDeleteRetentionInDays": 7` | Properties of the Storage Account Key Managing Key Vault. |
| `automationAccountIdentityPermissions\permissions\storage` | `array` | `["get","list","delete","set","update","regeneratekey","getsas","listsas","deletesas","setsas","recover","backup","restore","purge"]` | Permissions required by the Automation Account Managed Identity on the Key Vault to allow adding storage accounts for management. |
| `policyMetadata` | `string` | `EvidenELZ` | Metadata information for the DINE Policy |

> **Note**
> 
> It is recommended to only change these values after consulting the Microsoft documentation and the ELZ Azure engineering team.
## Outputs

None.