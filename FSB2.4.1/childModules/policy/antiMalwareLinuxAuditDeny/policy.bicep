/*
SUMMARY: Anti Malware Deny Linux Policy child module.
DESCRIPTION: Deployment of Anti Malware Deny Linux Policy. Consists of definition & assignment.
AUTHOR/S: bart.decker@eviden.com
VERSION: 0.0.1
*/

// SCOPE
targetScope = 'subscription' //Deploying at Subscription scope. Scope for Azure Policy can be Management Group(MG) or Subscription. ELZ Azure does not target MGs.

// PARAMETERS
@description('Specify metadata source value required for billing and monitoring')
param policyMetadata string

@description('Desired effect to set, when an Eviden antimalware tag attached to a Linux Virtual Machine is detected.')
@allowed([
  'Audit'
  'Deny'
  'Disabled'
])
param antimalwareLinuxEffect string

@description('Specify name for antimalware linux audit deny policy')
param antiMalwareLinuxAuditDenyDefName string

@description('Specify display name for antimalware linux audit deny policy')
param antiMalwareLinuxAuditDenyDefDisplayName string

@description('Specify name for assignment of antimalware linux audit deny policy')
param antiMalwareLinuxAuditDenyDefAssignmentName string

@description('Specify display name for assignment of antimalware linux audit deny policy')
param antiMalwareLinuxAuditDenyDefAssignmentDisplayName string

@description('Tag used for the policy rule')
param policyRuleTag string

// VARIABLES

//Variable which holds the definition details
var definitionProperties = {
  description: 'This policy will deny all virtual machines creation if the selected OS version is not compatible with the AntiMalware extensions and it has the EvidenAntimalware tag'
  metadata: {
    source: policyMetadata
    version: '0.0.1'
    category: 'Regulatory Compliance'
  }
  mode: 'All'
  policyType: 'Custom' //The type of policy definition. Possible values are NotSpecified, BuiltIn, Custom, and Static.
}

//Variable which holds the assignment details
var assignmentProperties = {
  #disable-next-line no-loc-expr-outside-params //Policies resources are not deployed to a region, like other resources, but the metadata is stored in a region hence requiring this to keep input parameters reduced.
  location: deployment().location
  identityType: 'SystemAssigned' //The identity type. This is the only required field when adding a system to a resource. Possible values 'None' & 'SystemAssigned'
  description: 'This policy will deny all virtual machines creation if the selected OS version is not compatible with the AntiMalware extensions and it has the EvidenAntimalware tag'
  metadata: {
    source: policyMetadata
    version: '0.0.1'
  }
}

// RESOURCE DEPLOYMENTS
//Deploy the policy definition
resource policyDefinition 'Microsoft.Authorization/policyDefinitions@2021-06-01' = {
  name: antiMalwareLinuxAuditDenyDefName
  properties: {
    description: definitionProperties.description
    displayName: antiMalwareLinuxAuditDenyDefDisplayName
    metadata: definitionProperties.metadata
    mode: definitionProperties.mode
    parameters: {
      effect:{
        type: 'String'
        metadata: {
          displayName: 'effect'
        }
      }
    }
    policyRule: {
      if: {
        allOf: [
          {
            field: 'type'
            equals: 'Microsoft.Compute/virtualMachines'
          }
          {
            field: 'tags.${policyRuleTag}'
            exists: true
          }
          {
            anyOf: [
              {
                field: 'Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType'
                contains: 'Linux'
              }
              {
                field: 'Microsoft.Compute/virtualMachines/osProfile.linuxConfiguration'
                exists: true
              }
            ]
          }
        ]
      }
      then: {
        effect: '[parameters(\'effect\')]'
      }
    }
    policyType: definitionProperties.policyType
  }
}

//Deploy the policy assignment
resource policyAssignment 'Microsoft.Authorization/policyAssignments@2021-06-01' = {
  name: antiMalwareLinuxAuditDenyDefAssignmentName
  location: assignmentProperties.location
  identity: {
    type: assignmentProperties.identityType
  }
  properties: {
    description: assignmentProperties.description
    displayName: antiMalwareLinuxAuditDenyDefAssignmentDisplayName
    metadata: assignmentProperties.metadata
    parameters: {
      effect: {
        value: antimalwareLinuxEffect
      }
    }
    policyDefinitionId: policyDefinition.id
  }
}

// OUTPUTS
