# PowerShell AL Listener for Azure

This is the Abstraction layer listener used for Azure, it handles both CMDB and ALERTS events.
Since release 2.2, it also supports native ServiceNow instances (see onboarding instructions for more details)

## CMDB Management

The following JSON payload needs to be sent to create/update/delete the CI in the CMDB.

- **eventtype** : Needs to be set to '**create_or_update**' or '**delete**'
- **targetsnowenv** : Needs to be set to '**DEFAULT**', or to a valid Snow ENV name. If DEFAULT, the FO name will be taken from the configuration setting.
- **targetsnowfo** : Needs to be set to '**DEFAULT**' or to a valid Snow FO. If DEFAULT, the FO name will be taken from the configuration setting.
- **resourceId** : The full resource ID of the Azure resource

```
{
	"payloadtype":"itsm-cmdb",
	"eventtype":"create_or_update",
	"targetsnowenv":"DEFAULT",
	"targetsnowfo":"DEFAULT",
  "resourceid":"/subscriptions/4835cc54-d5c8-41f4-bca9-ab13fc6fa61f/resourceGroups/dv4-lnd1-t-rsg-resources-CESAZURE-548/providers/Microsoft.Compute/virtualMachines/testvmfred0012"
}
```

### Adding additional classes

To add additional classes/resources, you need to update :

- The functions '**GetCMDBAzureSupportedResourceTypes**' with the new resource type.
  (in "psfunctions-atf.ps1" for ATF ServiceNow, and in "psfunctions-native.ps1" for Native ServiceNow)
- The function '**CreateCMDBConfigurationItem**' with the new resource type
- The classes folder/files if the resource need a new ServiceNow class

## ALERT Management

The following JSON payload needs to be sent to create an event/incident in ServiceNow

- **targetsnowenv** : Needs to be set to '**DEFAULT**', or to a valid Snow ENV name. If DEFAULT, the FO name will be taken from the configuration setting.
- **targetsnowfo** : Needs to be set to '**DEFAULT**' or to a valid Snow FO. If DEFAULT, the FO name will be taken from the configuration setting.
- **dateTimeOccured** : The date when the alert was generated by Azure. If not provided, default to the current time. (optional)
- **eventCategory** : Needs to be set to '**DEFAULT**' or to a valid Category. If DEFAULT, the Category will be taken from the configuration setting. (optional)
- **eventSeverity** : Needs to be set to 'critical','error' or 'warning'. If not specified, the severity will be taken from the configuration setting. (optional)
- **eventMessageText** : The full message text of the alert description that will be included in the ticket.
- **genericCIMonitoringId** : Needs to be set to '**DEFAULT**' or to a valid generic monitoring ID. If DEFAULT, the generic-ci monitoring ID will be taken from the configuration setting.
- **resourceId** : The full resource ID of the Azure resource if the alert if targeted to a resource (optional)
- **forcedMonitoringId** : Specify a monitoring ID to be used instead of the normal monitoring ID (optional)

```
{
	"payloadtype":"itsm-event",
	"targetsnowenv":"DEFAULT",
	"targetsnowfo":"DEFAULT",
  "dateTimeOccured": "2022-11-29T19:42:25.9938481Z",
  "eventCategory": "DEFAULT",
  "eventSeverity": "error",
  "eventMessageText": "this is the description message for the alert",
  "genericCIMonitoringId": "DEFAULT",
  "resourceid":"/subscriptions/4835cc54-d5c8-41f4-bca9-ab13fc6fa61f/resourceGroups/dv4-lnd1-t-rsg-resources-CESAZURE-548/providers/Microsoft.Compute/virtualMachines/testvmfred0012",
  "forcedMonitoringId": ""
}
```

More information in the Eviden Landingzones for Azure solution.WIKI :
https://docs.cloud.eviden.com/02.%20Eviden%20Landing%20Zones/02.%20AZURE/02.-Release-2.3/02.-Solutions/04.-ITSM-Integration/02.-How-To-Guides/02.-Configure/000-ATF2-ServiceNow-integration/








