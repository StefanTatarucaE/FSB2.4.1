# Firewall Parent module <!-- omit in toc -->

Azure Bicep parent module to deploy the Firewall related resource in the Connectivity subscription

## Navigation <!-- omit in toc -->

- [Description](#description)
  
  - [Naming convention module](#naming-convention-module)

- [Parent module parameters](#parent-module-parameters)
    - [Parameter detail: `firewallRuleCollectionGroups`](#parameter-detail-firewallRuleCollectionGroups)
    - [Parameter detail: `firewallIntrusionDetection`](#parameter-detail-firewallIntrusionDetection)
- [ELZ Azure Configuration Values](#elz-azure-configuration-values)
- [Parameter usage examples](#parameter-usage-examples)
  - [Parameter usage: `firewallRuleCollectionGroups`](#parameter-usage-firewallRuleCollectionGroups)
  - [Parameter usage: `firewallIntrusionDetection`](#parameter-usage-firewallIntrusionDetection)
- [Example parameters file for deployments](#example-parameters-file-for-deployments)
- [Outputs](#outputs)

## Description

The Firewall parent module calls several child modules in the `childModules` folder to deploy the resources, which together form the Firewall solution.

This module can deploy the Firewall Policy (with Rules) and Azure Firewall resources

 **Note:**
 In order to enable TLS inspection for Azure Firewall, the required  prerequisites must be deployed. The deployment of the prerequisites is handled in the Networking parent module based on `deployFirewallTlsPrerequisites` parameter

 TLS inspection required resources:

- Azure KeyVault
- Certificate stored in KeyVault
- Managed Identity that will have `get` and `list` permissions inside the KeyVault for accessing the certificate.

### Resources deployed in the Connectivity subscription

- A resource group to hold the firewall policy
- A firewall policy with defaulf elz Network & Application rule collections. (optional)
- A firewall (optional)
- Firewall IDPS configuration (optional only for use in combination with firewall premium sku)
- Firewall Policy Analytics (optional)

### Naming convention module

To ensure & enforce the required naming convention, the helper naming module is used by all other child modules.
The names being generated by the naming module are the actual resource names which are used on the Azure platform.

The naming convention module is run in a previous stage of the workflow. The output from the module is saved to a file and published as a workflow artifact. In subsequent jobs the artifact is downloaded and used by Bicep parent modules.

The downloaded artifact is referenced by parent modules by declaring a '*Naming' variable. For example: `var mgmtNaming = json(loadTextContent('../../mgmtNaming.json'))`

## Upgrading an existing elz deployment

For best results when upgrading from 1.x to 2.x and higher versions, follow & apply the guidelines & configuration values described in this section.

### Connectivity subscription  - configuration values

#### Firewall & Firewall Policy SKU

It's not possible to upgrade an existing firewall & firewall policy which uses the Standard sku to a firewall & firewall policy which uses the Premium sku by setting the azureFirewallSku & azureFirewallPolicySku to Premium without dissoaciating the Firewall Policy from the Azure Firewall.

Very important : Upgrading the SKU will require downtime !

In order to upgrade from Standard Azure Firewall & Firewall Policy to Premium Azure Firewall & Firewall Policy, please use the following guidance :

1. Make sure you have all the Firewall rules declared in code (check `firewallRuleCollectionGroups` parameter).

2. Deallocate firewall using below PowerShell script or you can follow [this link](https://techcommunity.microsoft.com/t5/azure-networking-blog/how-to-migrate-an-existing-standard-azure-firewall-to-premium/ba-p/3194059)
```
$firewall=Get-AzFirewall -ResourceGroupName <rsg_Name> -Name <fw_Name>
$firewall.Deallocate()
$firewall | Set-AzFirewall
```
3. Modify the `azureFirewallSku` and `azureFirewallPolicySku` input parameters from `Standard` to `Premium`.
4. Run the CNTY workflow from Github Actions
5. Check that Azure Firewall & Firewall Policy were upgraded to Premium SKU.

The workflow will deploy an additional Firewall policy named similar but with `-premium` appended at the end. The original (Standard SKU) Firewall Policy will remain and it can be removed once all the checks and tests were performed.

## Parent module parameters


| Parameter Name | Type | Required | Description |
| :-- | :-- | :-- | :-- |
| `deployAzureFirewall` | `bool` | `false`| Specifies if Azure Firewall is to be deployed. |
| `deployFirewallPolicy` | `bool` | `false`| Specifies if Azure Firewall Policy is to be deployed. |
| `azureFirewallPolicySku` | `string` | `Standard` | The Azure Firewall SKU associated with the Firewall Policy to deploy. Standard or Premium are available. |
| `azureFirewallSku` | `string` | `Standard` | The Azure Firewall SKU associated with the Firewall to deploy. Standard or Premium are available. |
| `enableTlsInspection` | `bool` | `true` | Specifies if TLS inspection should be enabled for Firewall Policy. If set to true, at the time of the deployment, a Certificate inside a KeyVault should exist before running this module. In Greenfield deployments, (if the prerequisite don't already exist), we will have to run the workflow twice. For the first run set this to false, wait for the deployment to finish and manually upload/generate the certificate inside the keyvault. In the second run of the cnty workflow the value should be set to true. The workflow now expects that the certificate is already uploaded in the keyvault and the values for keyvault Name, Certificate Secret ID and Firewall Managed Identity ID have to be populated as well |
| `firewallPolicyEnableProxy` | `bool` | `false` | Specifies whether to enable or disable DNS Proxy on Firewalls attached to the Firewall Policy. |
| `firewallPolicyDnsServers` | `array` | `false` | Specifies the DNS servers on Firewalls attached to the Firewall Policy. |
| `tlsKeyVaultName` | `string` | `false` | Name of the KeyVault used by TLS inspection. |
| `tlsKeyVaultCertId` | `string` | `false` | Specifies Secret ID of the Certificate stored in the KeyVault required by TLS inspection |
| `firewallUserIdentity` | `string` | `false` | Specifies the resource ID of the Managed Identity required by the TLS inspection |
| `enableFirewallIntrusionDetection` | `bool` | `false`| Specifies if Azure Firewall intrusion detection is enabled. Goes together with firewallIntrusionDetection parameter |
| [`firewallIntrusionDetection`](#parameter-detail-firewallIntrusionDetection) | `object` | `{}` | An object which holds the intrusion detection protection system (IDPS) configuration.  |
| `additionalNetworkingTags` | `object` | `{}` | Specifies a mapping of additional tags to assign to resources of the Azure Firewall and Firewall policy components. |
| `firewallThreatIntelMode` | `string` | `Alert` | Specifies the operation mode for Firewall Policy Threat Intelligence. Default set to "Alert"'. |
| `firewallPolicyWhitelistFqdns` | `array` | `[]`| Specifies an array of FQDNs for the ThreatIntel Allowlist. Default: [] |
| `firewallPolicyWhitelistIpAddresses` | `array` | `[]` | List of IP addresses for the ThreatIntel Allowlist. Default: []. Use empty array for deployments not scoped to Connectivity subscription. |
| `firewallRuleCollectionGroups` | `array` | `[]` | Specifies an array of Rule Collection Groups, containing all Rule Collections (Network, Application and DNAT) with Rules |
| `firewallAvailabilityZones` | `array` | `[]` | Specifies an array of Availability zone numbers e.g. 1,2,3. |
| `firewallNrOfPublicIps` | `int` | `1` | Specifies the number of Public IP Addresses the Firewall will use. (min 1 and max 100) |
| `enableFirewallPolicyAnalytics` | `bool` | `false`| Specifies if Azure Firewall Policy Analytics is enabled. |
| `managementSubscriptionId` | `string` | true | The Id of the management subscription. To be provided by the workflow|

#### Parameter detail: `firewallIntrusionDetection`

An json object which holds the intrusion detection protection system (IDPS) configuration. 

The json object is shown at the detail section of the readme:

- [Parameter detail: `firewallIntrusionDetection`](#parameter-detail-firewallIntrusionDetection)

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `description` | string | ` ` | Description of the bypass traffic rule. |
| `destinationAddresses` | string[] | `[]` | List of destination IP addresses or ranges for this rule. destinationIpGroups and destinationAddresses are mutually exclusive.|
| `destinationIpGroups` | string[] | `[]` | List of destination IpGroups for this rule. destinationIpGroups and destinationAddresses are mutually exclusive. |
| `destinationPorts` | string[] | `[]` | List of destination ports or ranges.  |
| `name` | string | ` ` | Name of the bypass traffic rule.  |
| `protocol` | string | ` ` | The rule bypass protocol. Possible options are ANY, ICMP, TCP, UDP |
| `sourceAddresses` | string[] | `[]` | List of source IP addresses or ranges for this rule. sourceIpGroups and sourceAddresses are mutually exclusive |
| `sourceIpGroups` | string[] | `[]` | List of source IpGroups for this rule. sourceIpGroups and sourceAddresses are mutually exclusive |
| `privateRanges` | string[] | `[]` | IDPS Private IP address ranges are used to identify traffic direction (i.e. inbound, outbound, etc.). By default, only ranges defined by IANA RFC 1918 are considered private IP addresses. To modify default ranges, specify your Private IP address ranges with this property. Using an empty list will result in the use of the default IANA RFC 1918 ranges.  |
| `id` | string | ` ` | Signature id of the signature to override. |
| `mode` | string | ` ` | mode as part of signatureOverrides. The signature state. Possible options are Alert, Deny, Off |
| `mode` | string | ` ` | mode as part of intrusionDetection. Intrusion detection general state. Possible options are Alert, Deny, Off |

Check the source information on Microsoft [documentation](https://learn.microsoft.com/en-us/azure/templates/microsoft.network/firewallpolicies?pivots=deployment-language-bicep).

#### Parameter detail: `firewallRuleCollectionGroups`

> **Note**
> The firewall policy & collections & rules are a bit of a mess and should be re-checked & refactored to be more flexible & readable.

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `name` | `string` | Specifies the name of the Rule Collection Group |
| `properties` | `string` | Specifies the properties of the Rule Collection group |
##### Sub-Property detail: `Properties`

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `priority` | `int` | Specifies the name of the Rule Collection Group |
| `ruleCollection` | `Array` | Specifies the Rule Collections array |

##### Sub-Property detail: `ruleCollection`

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `name` | `string` | Specifies the network rule collection name. |
| `ruleCollectionType` | `string` | Specifies the collection type. **Cannot decipher if this parameter is actually being applied in the code.** |
| `priority` | `int` | Specifies the rule collection priority. |
| `action` | `object` | Specifies the rule collection action. |
| [`rules`](#parameter-detail-firewallpolicynetworkrulecollectionrules) | `array` |  Specifies an array of rules objects included in the rule collection.  |

##### Sub-Property detail: `rules` (Network Rules)

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `name` | `string` | Specifies the name of the rule. |
| `ruleType` | `string` | Specifies the rule type.  |
| `ipProtocols` | `string[]` | Specifies a string array of FirewallPolicyRuleNetworkProtocols. |
| `sourceAddresses` | `string[]` | Specifies the list of source IP addresses for this rule. |
| `sourceIpGroups` | `string[]` | Specifies the list of source IpGroups for this rule. |
| `destinationAddresses` | `string[]` | Specifies the list of destination IP addresses or Service Tags.|
| `destinationIpGroups` | `string[]` | Specifies the list of destination IpGroups for this rule. |
| `destinationFqdns` | `string[]` | Specifies the list of destination FQDNs. |
| `destinationPorts` | `string[]` | Specifies the list of destination ports. |

#### Sub-Property detail: `rules` (Application Rules)

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `name` | `string` | Specifies the name of the rule.  |
| `ruleType` | `string` | Specifies the rule type. |
| `protocols` | `array` | Specifies an array of Application Protocols.  |
| `fqdnTags` | `string[]` | Specifies the list of FQDN Tags for this rule.  |
| `webCategories` | `string[]` | Specifies the list of destination Azure web categories. |
| `targetFqdns` | `string[]` | Specifies the list of target FQDNs for this rule.  |
| `targetUrls` | `string[]` | Specifies the list of target Urls for this rule condition. |
| `terminateTls` | `bool` | `false` | Specify to enable or disable TLS termination the connections specified in the rule.  |
| `sourceAddresseses` | `string[]` | Specifies the list of source IP addresses for this rule. |
| `destinationAddresses` | `string[]` | Specifies the list of destination IP addresses or Service Tags. |
| `sourceIpGroups` | `string[]` | Specifies the list of source IpGroups for this rule. |

#### Sub-Property detail: `rules` (DNAT Rules)

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `name` | `string` | Specifies the name of the rule.  |
| `ruleType` | `string` | Specifies the rule type. |
| `destinationAddresses` | `string[]` | Specifies the list of destination IP addresses or Service Tags. |
| `destinationPorts` | `string[]` | Specifies the list of destination ports. |
| `ipProtocols` | `string[]` | Specifies a string array of FirewallPolicyRuleNetworkProtocols. |
| `sourceAddresseses` | `string[]` | Specifies the list of source IP addresses for this rule. |
| `sourceIpGroups` | `string[]` | Specifies the list of source IpGroups for this rule. |
| `translatedAddress` | `string` | The translated address for this NAT rule. |
| `translatedFqdn` | `string` | The translated FQDN for this NAT rule. |
| `translatedPort` | `string` | The translated port for this NAT rule. |
## elz Azure Configuration Values

There are currently no specific elz configuration values.

## Parameter usage examples

The following examples show how to use the more abstract parameters (objects & array of objects) in the Networking parent module.


</details>
</p>

### Parameter usage: `firewallIntrusionDetection`

<p>
<details>

<summary>Parameter JSON format</summary>

```json
"firewallIntrusionDetection": {
            "value": {
                "intrusionDetection": {
                    "configuration": {
                        "bypassTrafficSettings": [
                            {
                                "description": "test",
                                "destinationAddresses": [
                                    "10.4.5.6"
                                ],
                                "destinationIpGroups": [],
                                "destinationPorts": [
                                    "80"
                                ],
                                "name": "test",
                                "protocol": "tcp",
                                "sourceAddresses": [
                                    "10.1.3.4"
                                ],
                                "sourceIpGroups": []
                            }
                        ],
                        "privateRanges": [
                            "10.0.0.0/8",
                            "172.16.0.0/12",
                            "192.168.0.0/16",
                            "100.64.0.0/10"
                        ],
                        "signatureOverrides": [
                            {
                            "id": "2000015",
                            "mode": "Alert"
                            }
                        ]
                    },
                    "mode": "alert"
                }
            }
        }
```

</details>
</p>



### Parameter usage: `firewallRuleCollectionGroups`

<p>
<details>

<summary>Parameter JSON format</summary>

```json
        "firewallRuleCollectionGroups": {
            "value": [
                {
                    "name": "DefaultApplicationRuleCollectionGroup",
                    "properties": {
                        "priority": 1500,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Application-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "ExampleEvidenAllowMicrosoft",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.microsoft.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowBackup",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [
                                            "AzureBackup"
                                        ],
                                        "webCategories": [],
                                        "targetFqdns": [],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowUpdateManagement",
                                        "protocols": [
                                            {
                                                "protocolType": "Http",
                                                "port": 80
                                            },
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [
                                            "WindowsUpdate"
                                        ],
                                        "webCategories": [],
                                        "targetFqdns": [],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowOMS",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.ods.opinsights.azure.com",
                                            "*.oms.opinsights.azure.com",
                                            "*.blob.core.windows.net"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                      "ruleType": "ApplicationRule",
                                      "name": "EvidenAllowAMA",
                                      "protocols": [
                                          {
                                              "protocolType": "Https",
                                              "port": 443
                                          }
                                      ],
                                      "fqdnTags": [],
                                      "webCategories": [],
                                      "targetFqdns": [
                                          "*.ods.opinsights.azure.com",
                                          "*.handler.control.monitor.azure.com"
                                      ],
                                      "targetUrls": [],
                                      "terminateTLS": false,
                                      "sourceAddresses": [
                                          "10.0.0.0/8"
                                      ],
                                      "destinationAddresses": [],
                                      "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowQualys",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.apps.qualys.eu",
                                            "*.apps.qualys.co.uk",
                                            "*.apps.qualys.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowWindowsLinux",
                                        "protocols": [
                                            {
                                                "protocolType": "Http",
                                                "port": 80
                                            },
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.windows.com",
                                            "*.ubuntu.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowWindowsNet",
                                        "protocols": [
                                            {
                                                "protocolType": "Http",
                                                "port": 80
                                            },
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.windows.net"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    }
                                ]
                            },
                            {
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": [],
                                "name": "Example-Eviden-Application-Deny-RC",
                                "priority": 500
                            }
                        ]
                    }
                },
                {
                    "name": "DefaultNetworkRuleCollectionGroup",
                    "properties": {
                        "priority": 100,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Network-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1ToLnd2",
                                        "ipProtocols": [
                                            "Any"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "*"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2ToLnd1",
                                        "ipProtocols": [
                                            "Any"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "*"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1toAzureMonitor",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "AzureMonitor"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2toAzureMonitor",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "AzureMonitor"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1toGuestAndHybrid",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "GuestAndHybridManagement"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2toGuestAndHybrid",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "GuestAndHybridManagement"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1toKMS",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "23.102.135.246"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "1688"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2toKMS",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "23.102.135.246"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "1688"
                                        ]
                                    }
                                ]
                            },
                            {
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [],
                                "name": "Cust-Example-Network-Allow-RC",
                                "priority": 1000
                            }
                        ]
                    }
                }
            ]
        }
```

</details>
</p>

## Example parameters file for deployments

An example of the required values for parameters are described in the following section.
The values mentioned in this example are **not** default and **must** be defined for the parent module to run successfully.

<p>
<details><summary>firewall parameter example</summary>

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "additionalNetworkingTags": {
            "value": {}
        },
        "deployAzureFirewall": {
            "value": true
        },
        "azureFirewallSku": {
            "value": "Premium"
        },
        "deployFirewallPolicy": {
            "value": true
        },
        "azureFirewallPolicySku": {
            "value": "Premium"
        },
        "tlsKeyVaultName": {
            "value": "dv2-cnty-d-kvt-tls"
        },
        "firewallUserIdentity": {
            "value": "/subscriptions/250411cd-988d-4075-9436-76e77bca684f/resourcegroups/dv2-cnty-d-rsg-hub-network/providers/Microsoft.ManagedIdentity/userAssignedIdentities/dv2-cnty-d-euwe-tls-identity"
        },
        "tlsKeyVaultCertId": {
            "value": "https://dv2-cnty-d-kvt-tls.vault.azure.net/secrets/tlsCert/6859dd80d6ab4b7dbf90063a439d1214"
        },
        "enableTlsInspection": {
            "value": true
        },
        "enableFirewallPolicyAnalytics": {
            "value": true
        },
        "firewallPolicyEnableProxy": {
            "value": false
        },
        "firewallPolicyDnsServers": {
            "value": []
        },
        "firewallNrOfPublicIps":{
            "value": 1
        },
        "firewallAvailabilityZones":{
            "value": []
        },
        "firewallRuleCollectionGroups": {
            "value": [
                {
                    "name": "DefaultApplicationRuleCollectionGroup",
                    "properties": {
                        "priority": 1500,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Application-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "ExampleEvidenAllowMicrosoft",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.microsoft.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowBackup",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [
                                            "AzureBackup"
                                        ],
                                        "webCategories": [],
                                        "targetFqdns": [],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowUpdateManagement",
                                        "protocols": [
                                            {
                                                "protocolType": "Http",
                                                "port": 80
                                            },
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [
                                            "WindowsUpdate"
                                        ],
                                        "webCategories": [],
                                        "targetFqdns": [],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowOMS",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.ods.opinsights.azure.com",
                                            "*.oms.opinsights.azure.com",
                                            "*.blob.core.windows.net"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                      "ruleType": "ApplicationRule",
                                      "name": "EvidenAllowAMA",
                                      "protocols": [
                                          {
                                              "protocolType": "Https",
                                              "port": 443
                                          }
                                      ],
                                      "fqdnTags": [],
                                      "webCategories": [],
                                      "targetFqdns": [
                                          "*.ods.opinsights.azure.com",
                                          "*.handler.control.monitor.azure.com"
                                      ],
                                      "targetUrls": [],
                                      "terminateTLS": false,
                                      "sourceAddresses": [
                                          "10.0.0.0/8"
                                      ],
                                      "destinationAddresses": [],
                                      "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowQualys",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.apps.qualys.eu",
                                            "*.apps.qualys.co.uk",
                                            "*.apps.qualys.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowWindowsLinux",
                                        "protocols": [
                                            {
                                                "protocolType": "Http",
                                                "port": 80
                                            },
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.windows.com",
                                            "*.ubuntu.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    },
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowWindowsNet",
                                        "protocols": [
                                            {
                                                "protocolType": "Http",
                                                "port": 80
                                            },
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.windows.net"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "10.0.0.0/8"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    }
                                ]
                            },
                            {
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": [],
                                "name": "Example-Eviden-Application-Deny-RC",
                                "priority": 500
                            }
                        ]
                    }
                },
                {
                    "name": "DefaultNetworkRuleCollectionGroup",
                    "properties": {
                        "priority": 100,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Network-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1ToLnd2",
                                        "ipProtocols": [
                                            "Any"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "*"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2ToLnd1",
                                        "ipProtocols": [
                                            "Any"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "*"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1toAzureMonitor",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "AzureMonitor"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2toAzureMonitor",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "AzureMonitor"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1toGuestAndHybrid",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "GuestAndHybridManagement"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2toGuestAndHybrid",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "GuestAndHybridManagement"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "443",
                                            "80"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd1toKMS",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.5.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "23.102.135.246"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "1688"
                                        ]
                                    },
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowLnd2toKMS",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "sourceAddresses": [
                                            "10.6.0.0/16"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "23.102.135.246"
                                        ],
                                        "destinationIpGroups": [],
                                        "destinationFqdns": [],
                                        "destinationPorts": [
                                            "1688"
                                        ]
                                    }
                                ]
                            },
                            {
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [],
                                "name": "Cust-Example-Network-Allow-RC",
                                "priority": 1000
                            }
                        ]
                    }
                }
            ]
        }
}
```

</details>
</p>


## Outputs

None.
