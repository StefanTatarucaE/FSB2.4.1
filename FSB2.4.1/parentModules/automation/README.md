# Automation Parent module
Azure Bicep parent module to create the Core automation resources for the Eviden Landingzones for Azure solution.

## Description
This parent module calls several child modules in the modules folder and deploys several resources required for the automation solution in the mgmt subscription.

The following resources are created:

 - A resource group for all the resources.
 - An Automation Account
 - Deployment of runbooks, schedule and webhook

### Naming convention module
To ensure & enforce the required naming convention, the helper evidenNaming module is used by all other child modules.
The names being generated by the naming module are the actual resource names which are used on the Azure platform.
The naming convention module is run in a previous stage of the pipeline. The output from the module is saved to a file and published as a pipeline artifact. In subsequent stages the artifact is downloaded and used by Bicep parent modules.

## Parent module overview
The parent module has been configured as follows:
1. First the output of the naming module is loaded via a variable.
1. The resource groups are defined next.
1. After the resource group block, the Automation Account is defined.


### Parent module parameters

**Required parameters**

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `location` | `string` | Specifies the location where the resource will be deployed. |
| `deploymentType` | `string` | Specify the type of deployment. Allowed values are config and deploy. To be provided by the pipeline. |
| `typeOfArtifacts` | `string` | Specify the type of artifacts to upload in automation account. To be provided by the pipeline. Default value 'core' is set to make this parameter optional, when deploymentType is 'deploy'. This parameter is mandatory when deploymentType is 'config'. Allowed values are core , paas-mgmt , monitoring-core and os-mgmt |

**Optional parameters**

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `additionalAutomationTags` | `object` | `{}` | A mapping of additional tags to assign to all the resources. |
| `artifactsTimeZone` | `string` | `Europe/Amsterdam` | Specifies the Timezone for runbook schedules |


## Example parameters file
The required values for parameters are described in the following example of a parameters file.
The values mentioned in this example are **not** default and **must** be defined for the parent module to run successfully.

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "additionalAutomationTags": {
            "value": {}
        },
        "deploymentType": {
            "value": "deploy"
        },
        "typeOfArtifacts": {
            "value": "core"
        }
    }
}

```

## ELZ Azure Configuration Values

The parentModule folder (where the automation.bicep file resides) contains a `parentModuleConfig.json` file. This json file holds the default configuration for the Automation account deployment. The values from the json file maps to the automationAccount child module parameters.

The `parentModuleConfig.json` file is referenced by the Automation parent module by declaring a 'parentModuleConfig' variable; `var parentModuleConfig = loadJsonContent('parentModuleConfig.json')`.

In the following table the configuration defaults are described.

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `automationAccountSkuName` | `string` | `Free` | Valid options are Free, Basic. Microsoft always sets SKU to Free irrespective of the value provided. ELZ uses `Free` SKU for automation accounts. |

> **Note** 
> It is recommended to change these values only after consulting the ELZ Azure engineering team.

## Outputs


| Name | Description | Value
| --- | --- | --- |
| `automationResourceGroupName` | The name of the deployed resource group. | `automationResourceGroup.name` |
| `automationResourceGroupResourceId` | The resource id of deployed resource group. | `automationResourceGroup.id` |
| `customerAutomationAccountName` | The name of the deployed automation account. | `automationAutomationAccount.outputs.automationAccountName` |