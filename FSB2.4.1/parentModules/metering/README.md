# Metering Parent module
Azure Bicep parent module to create the Metering/Billing resources for the Eviden Landingzones for Azure solution.

## Description
This parent module calls several child modules in the modules folder and deploys several resources required for the metering solution.

The following resources are created:

 - A resource group for all the resources.
 - A storageAccount used with the functionApp for metering.
 - A keyvault to store the secrets needed by the function app.
 - A functionApp for metering (the python version) (+ the corresponding AppServicePlan & AppInsights)
 - Access policy to provide access to the function app system identity to the key vault secrets.

### Naming convention module
To ensure & enforce the required naming convention, the helper Naming module is used by all other child modules.
The names being generated by the naming module are the actual resource names which are used on the Azure platform.
The naming convention module is run in a previous stage of the pipeline. The output from the module is saved to a file and published as a pipeline artifact. In subsequent stages the artifact is downloaded and used by Bicep parent modules.

## Parent module overview
The parent module has been configured as follows:
1. First the output of the naming module is loaded via a variable.
1. The resource groups are defined next.
1. After the resource group block, storage account  and Key vault is defined.
1. In the following section a functionApp for the python metering code is defined, together with AppServicePlan & AppInsights.
1. Finally the access policy for the keyvault is defined.

**Required parameters**

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `appServiceProperties.BillingCountryCode` | `string` | Specifies the the billing country code to be used in the naming of the billing csv file. It should be in line with the world currency symbols.|
| `appServiceProperties.BillingCurrencyFix` | `string` |  This is used when the function does not return correct value for cost. Azure normally does the conversion to a particular currency for us automatically, however in some case eg. GBP pound it does not convert and provides value as 0. In this scenario we do the conversion ourselves. For this conversion to happen we need to enable this configuration.|

**Optional parameters**

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `additionalMeteringTags` | `object` |`{}` | A mapping of additional tags to assign to all the resources. |

The Purpose tag is required on some resources and it will be added automatically at deployment time.

## Example parameters file
The required values for parameters are described in the following example of a parameters file.
The values mentioned in this example are **not** default and **must** be defined for the parent module to run successfully.

```
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "additionalMeteringTags": {
            "value": {}
        }
    }
}

```

## ELZ Azure Configuration Values

The parentModule folder (where the bootstrap.bicep file resides) contains a `parentModuleConfig.json` file. This json file holds the default configuration for the Bootstrap storage account deployment. The values from the json file maps to the storageAccount child module parameters.

The `parentModuleConfig.json` file is referenced by the Bootstrap parent module by declaring a 'parentModuleConfig' variable; `var parentModuleConfig = loadJsonContent('parentModuleConfig.json')`.

In the following table the configuration defaults are described.

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `storageAccountKind` | `string` | `StorageV2` | Indicates the type of storage account. |
| `storageAccountSku` | `string` | `Standard_LRS` | The SKU of the storage account. |
| `storageAccountAccessTier` | `string` | `Hot` | Specify access tier used for metering. |
| `storageAccountAllowBlobPublicAccess` | `bool` | `false` | Allow or disallow public access to all blobs or containers in the storage account. |
| `storageAccountNetworkAcls` | `object` | `{ "bypass": "AzureServices, Logging, Metrics", "defaultAction": "Allow", "ipRules": [] } `| Network rule set; Specifies whether traffic is bypassed for Logging/Metrics/AzureServices. Default action, Allow action & the corresponding IP addresses or blocks. |
| `storageAccountChangeFeed` | `object` | `{"enabled": true,"retentionInDays": 7}` | The blob service properties for change feed events. |
| `storageAccountBlobSvcDeleteRetentionPolicy` | `object` | `{"enabled": true,"days": 7}` | The blobservice properties for soft delete. Enabled & days parameters. |
| `appServicePlanSku` | `object` | `{"name": "Y1","tier": "Dynamic"}` | Hosting Plan SKU object (name and tier). See Microsoft documentation for choosing the right SKU. |
| `appServicePlanKind` | `string` | `linux` | Hosting Plan Kind (possible values: Windows, Linux, elastic, FunctionApp) |
| `appInsightsKind` | `string` | `web` | App Insights Kind (possible values: web, ios, other, store, java, phone) |
| `appInsightsProperties` | `object` | `{"Request_Source": "IbizaWebAppExtensionCreate"}` | App Insights properties. Object of elements) |
| `appServiceKind` | `string` | `functionapp,linux` | App Service kind. Possible values: "api", "app", "app,linux", "functionapp", "functionapp,linux") |
| `appServiceProperties` | `array` | `[{"name":"FUNCTIONS_WORKER_RUNTIME","value":"python"},{"name":"FUNCTIONS_EXTENSION_VERSION","value":"~4"},{"name":"CUSTOM_POLICIES_METADATA","value":"{\"TagName\": \"source\",\"TagValue\": \"EvidenELZ\"}"},{"name":"BillingCountryCode","value":"GB"},{"name":"AUTOMATION_ACCOUNT_TAG","value":"{\"TagName\": \"EvidenPurpose\",\"TagValue\": \"EvidenVmOsManagementAutomation\"}"},{"name":"RECOVERY_VAULT_TAG","value":"{\"TagName\": \"EvidenPurpose\",\"TagValue\": \"EvidenRecoveryServicesVault\"}"},{"name":"GOOGLE_BUCKET_KEY_SECRET_NAME","value":"billing-google-bucket-key"},{"name":"GOOGLE_BUCKET_NAME_SECRET_NAME","value":"billing-google-bucket-name"},{"name":"IMG_GALLERY_TAG","value":"{\"TagName\": \"EvidenPurpose\",\"TagValue\": \"EvidenSharedImageGallery\"}"},{"name":"RATECARD_DATA","value":"[[{\"billincurrency\":\"EUR\",\"locale\":\"nl-NL\",\"RegionInfo\":\"NL\"},{\"billincurrency\":\"USD\",\"locale\":\"en-US\",\"RegionInfo\":\"US\"},{\"billincurrency\":\"GBP\",\"locale\":\"en-GB\",\"RegionInfo\":\"GB\"}]]"},{"name":"SERVICES_SPLIT_DATA","value":"[[{\"ServiceCategoryName\":\"IaaS\",\"Providers\":[\"Microsoft.Security\",\"Microsoft.Compute\",\"Microsoft.RecoveryServices\",\"Microsoft.Network\",\"Microsoft.Storage\"]},{\"ServiceCategoryName\":\"PaaS\",\"Providers\":[\"Microsoft.Web\",\"Microsoft.DataFactory\",\"Microsoft.EventGrid\",\"Microsoft.ServiceBus\",\"Microsoft.EventHub\",\"Microsoft.Databricks\",\"Microsoft.AnalysisServices\",\"Microsoft.PowerBI\",\"Microsoft.MachineLearningServices\",\"Microsoft.Automation\",\"Microsoft.Blueprint\",\"Microsoft.KeyVault\",\"Microsoft.OperationalInsights\",\"Microsoft.Insights\",\"Microsoft.Logic\"]},{\"ServiceCategoryName\":\"PaaS+\",\"Providers\":[\"Microsoft.DocumentDB\",\"Microsoft.Sql\",\"Microsoft.DBforPostgreSQL\",\"Microsoft.DBforMySQL\"]}]]"},{"name":"VM_BACKUP_TAG","value":"{\"TagName\": \"EvidenBackup\",\"TagValue\": \"*\"}"},{"name":"VM_COMPL_TAG","value":"{\"TagName\": \"EvidenManaged\",\"TagValue\": \"true\"}"},{"name":"VM_OSVERSION_TAG","value":"{\"TagName\": \"EvidenOsVersion\"}"},{"name":"VM_PATCH_TAG","value":"{\"TagName\": \"EvidenPatching\",\"TagValue\": \"*\"}"},{"name":"VNET_SPOKES_TAG","value":"{\"TagName\": \"EvidenManaged\",\"TagValue\": \"EvidenNetworkingSpoke\"}"}]` | Function App settings. Array of elements with required key and value pair for specific functionality |
| `appServiceClientAffinityEnabled` | `bool` | `true` | App Service Client Affinity enabled. (possible values: True or False) |
| `appServiceHttpsOnly` | `bool` | `true` | App Service Https Only. (possible values: True or False)' |
| `appServiceHttpsOnly` | `bool` | `true` | App Service Https Only. (possible values: True or False)' |
| `appServiceClientCertEnabled` | `bool` | `false` | App Client certificate enabled. (possible values: True or False)'|
| `appServiceSiteConfig` | `string` | `{"numberOfWorkers":-1,"defaultDocuments":["Default.htm","Default.html","Default.asp","index.htm","index.html","iisstart.htm","default.aspx","index.php"],"netFrameworkVersion":"v4.0","linuxFxVersion":"PYTHON3.8","requestTracingEnabled":false,"remoteDebuggingEnabled":false,"remoteDebuggingVersion":"VS2019","httpLoggingEnabled":false,"logsDirectorySizeLimit":35,"detailedErrorLoggingEnabled":false,"publishingUsername":"$ats-sub1-d-func-billing","azureStorageAccounts":{},"scmType":"None","use32BitWorkerProcess":false,"webSocketsEnabled":false,"alwaysOn":false,"managedPipelineMode":"Integrated","virtualApplications":[{"virtualPath":"/","physicalPath":"site\\wwwroot","preloadEnabled":false}],"loadBalancing":"LeastRequests","experiments":{"rampUpRules":[]},"autoHealEnabled":false,"cors":{"allowedOrigins":["https://functions.azure.com","https://functions-staging.azure.com","https://functions-next.azure.com"],"supportCredentials":false},"localMySqlEnabled":false,"managedServiceIdentityId":6564,"ipSecurityRestrictions":[{"ipAddress":"Any","action":"Allow","priority":1,"name":"Allow all","description":"Allow all access"}],"scmIpSecurityRestrictions":[{"ipAddress":"Any","action":"Allow","priority":1,"name":"Allow all","description":"Allow all access"}],"scmIpSecurityRestrictionsUseMain":false,"http20Enabled":true,"minTlsVersion":"1.2","ftpsState":"FtpsOnly","preWarmedInstanceCount":0}` | App Service Site Config object.|
| `skuName` | `string` | `standard` | Specifies the SKU details of the Key Vault. premium/standard. |
| `keyVaultFeatures` | `object` | `{"enabledForDeployment":true,"enabledForDiskEncryption":false,"enabledForTemplateDeployment":true,"enablePurgeProtection":false,"enableRbacAuthorization":false,"enableSoftDelete":true}` | Features to be enabled or disabled for the keyvault. |
| `publicNetworkAccess` | `string` | `enabled` | Specifies whether the Key Vault will accept traffic from public internet. If set to disabled it overrides all firewall rules, allowing only private endpoint and trusted services traffic. |
| `softDeleteRetentionInDays` | `int` | `15` | Number of retention days for soft delete, if the Soft Delete feature is enabled. Ignored if Soft Delete is not enabled. |
| `networkRuleBypassOptions` | `string` | `AzureServices` | Specifies what traffic can bypass the network rules. This can be AzureServices (default if not specified) or None. |
| `networkRuleAction` | `string` | `Allow` | The default action when no rule from ipRules and from virtualNetworkRules match. Evaluated after the networkRuleBypassOptions is evaluated. |

For more information on the storage account parameters, for which these default values are set please check the storageAccount child module [README](../../childModules/storageAccount/README.md).

> **Note**
> 
> It is recommended to only change these values after consulting the Azure engineering team.

## Outputs

| Name | Description | Value
| --- | --- | --- |
| `billingResourceGroupName` | The name of the deployed resource group. | `billingResourceGroup.name` |
| `billingFunctionAppName` | The name of the deployed billing function app. | `billingFunctionApp.outputs.appServiceName` |