# Deployment of firewall rule collection groups

This bicep module deploys firewall rule collection groups (firewall rules) for the virtual wan hub firewall policy.

## Navigation <!-- omit in toc -->

- [Description](#description)
- [Parent module parameters](#parent-module-parameters)
  - [Required parameters](#required-parameters)
- [Naming convention module](#naming-convention-module)
- [Parameter usage examples](#parameter-usage-examples)
  - [Parameter usage: `firewallRuleCollectionGroups`](#parameter-usage-firewallrulecollectiongroups)
- [Parameter File Examples](#parameter-file-examples)
- [Outputs](#outputs)

## Description

The virtualWanFirewallRules parent module deploys firewall rule collection groups (application and network rules) in the firewall policy part of the Virtual Wan deployment. Resources are only deployed in Connectivity Subscription (Secured Hub).

It calls a single child module in the `childModules` folder to deploy the solution, which is:
"../../childModules/virtualWanFirewallRules/virtualWanFirewallRules.bicep"

## Parent module parameters

Inputs are provided using the following parameter file, depending upon where you need the firewall rules deployed:

- cu7.cnty.virtualwanfirewallrules.params.json

### Required parameters

|  Name | Type | Description |
| :-- | :-- | :-- |
| `subscriptionType` | string | Parameter to determine the subscription using abbreviation. To be provided by the pipeline. |
| `azFirewallPolicySku` | string | Specifies the tier of the Firewall Policy. Allowed values are: "Basic", "Standard", "Premium". Make sure to set the value of this parameter identical to the one in the "virtualWanHubs" array from the "<env>.cnty.virtualWan.params.json parameter file. |
| `firewallRuleCollectionGroups` | array | This array represents the firewall rules (rule collection groups) within the Firewall Policy. |

### Naming convention module

To ensure & enforce the required naming convention, a naming helper module is used by all other parent modules.
The names being generated by the naming module are the actual resource names which are used on the Azure platform.

The naming helper module is run in `prepare` job of the workflow which is used to deploy ELZ Azure. The output from the module is saved to a file and published as a workflow artifact. In subsequent jobs the artifact is downloaded and used by Bicep parent modules.

The downloaded artifact is referenced by parent modules by declaring a '*Naming' variable. For example: `var mgmtNaming = json(loadTextContent('../../mgmtNaming.json'))`

## Parameter usage examples

The following examples show how to use the more abstract parameters (array of objects) in the virtualWanFirewallRules parent module.

### Parameter usage: `firewallRuleCollectionGroups`

<p>
<details>

<summary>Parameter JSON format</summary>

```json
        "applicationFirewallRuleCollectionGroups": {
            "value": [
                {
                    "name": "DefaultApplicationRuleCollectionGroup",
                    "properties": {
                        "priority": 1500,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Application-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowMicrosoft",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.microsoft.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    }
                                ]
                            },
                            {
                                "name": "Eviden-Application-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 500,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": []
                            },
                            {
                                "name": "Cu6-Application-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1000,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": []
                            },
                            {
                                "name": "Cu6-Application-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 100,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": []
                            }
                        ]
                    }
                },
                {
                    "name": "DefaultNetworkRuleCollectionGroup",
                    "properties": {
                        "priority": 100,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Network-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowTCP",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "destinationPorts": [
                                            "*"
                                        ],
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationIpGroups": [],
                                        "destinationAddresses": [
                                            "*"
                                        ],
                                        "destinationFqdns": []
                                    }
                                ]
                            },
                            {
                                "name": "Eviden-Network-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 500,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenDenyRDP",
                                        "ipProtocols": [
                                            "Any"
                                        ],
                                        "destinationPorts": [
                                            "3389"
                                        ],
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationIpGroups": [],
                                        "destinationAddresses": [
                                            "*"
                                        ],
                                        "destinationFqdns": []
                                    }
                                ]
                            },
                            {
                                "name": "Cu6-Network-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1000,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": []
                            },
                            {
                                "name": "Cu6-Network-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 100,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": []
                            }
                        ]
                    }
                },
                {
                    "name": "DefaultDnatRuleCollectionGroup",
                    "properties": {
                        "priority": 700,
                        "ruleCollections": [
                            {
                                "ruleCollectionType": "FirewallPolicyNatRuleCollection",
                                "action": {
                                    "type": "Dnat"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NatRule",
                                        "name": "AllowRDP",
                                        "translatedAddress": "192.168.0.1",
                                        "translatedPort": "3389",
                                        "ipProtocols": [
                                            "TCP",
                                            "UDP"
                                        ],
                                        "sourceAddresses": [
                                            "192.168.0.1"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "20.166.1.109"
                                        ],
                                        "destinationPorts": [
                                            "3389"
                                        ]
                                    }
                                ],
                                "name": "AllowRDP",
                                "priority": 700
                            }
                        ]
                    }
                }
            ]
        }
```

</details>
</p>

## Parameter File Examples

Please refer the parameter file provided for virtual wan firewall rules in the input folder of the repository.

**NOTE:** The parameter file in the input folder serves as an example only. It may not consist of every parameter that can be supplied to deploy the solution. Please read this readme file for details on every parameter that can be used. Update the parameter file as per the environment. Do not run the deployment, using these files as is (exception - dev\test environments).

In the input folder you should find a parameter file that you can refer to:

- example-environment-name.cnty.virtualwanfirewallrules.params.json

An example of the required values for parameters are described in the following section.
The values mentioned in this example are **not** default and **must** be defined for the parent module to run successfully.

<p>
<details><summary>firewall rules parameter file example</summary>

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subscriptionType": {
            "value": "cnty"
        },
        "azFirewallPolicySku": {
            "value": "Standard"
        },
        "firewallRuleCollectionGroups": {
            "value": [
                {
                    "name": "DefaultApplicationRuleCollectionGroup",
                    "properties": {
                        "priority": 1500,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Application-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "ApplicationRule",
                                        "name": "EvidenAllowMicrosoft",
                                        "protocols": [
                                            {
                                                "protocolType": "Https",
                                                "port": 443
                                            }
                                        ],
                                        "fqdnTags": [],
                                        "webCategories": [],
                                        "targetFqdns": [
                                            "*.microsoft.com"
                                        ],
                                        "targetUrls": [],
                                        "terminateTLS": false,
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "destinationAddresses": [],
                                        "sourceIpGroups": []
                                    }
                                ]
                            },
                            {
                                "name": "Eviden-Application-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 500,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": []
                            },
                            {
                                "name": "Cu6-Application-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1000,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": []
                            },
                            {
                                "name": "Cu6-Application-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 100,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": []
                            }
                        ]
                    }
                },
                {
                    "name": "DefaultNetworkRuleCollectionGroup",
                    "properties": {
                        "priority": 100,
                        "ruleCollections": [
                            {
                                "name": "Eviden-Network-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1500,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenAllowTCP",
                                        "ipProtocols": [
                                            "TCP"
                                        ],
                                        "destinationPorts": [
                                            "*"
                                        ],
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationIpGroups": [],
                                        "destinationAddresses": [
                                            "*"
                                        ],
                                        "destinationFqdns": []
                                    }
                                ]
                            },
                            {
                                "name": "Eviden-Network-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 500,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NetworkRule",
                                        "name": "EvidenDenyRDP",
                                        "ipProtocols": [
                                            "Any"
                                        ],
                                        "destinationPorts": [
                                            "3389"
                                        ],
                                        "sourceAddresses": [
                                            "*"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationIpGroups": [],
                                        "destinationAddresses": [
                                            "*"
                                        ],
                                        "destinationFqdns": []
                                    }
                                ]
                            },
                            {
                                "name": "Cu6-Network-Allow-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 1000,
                                "action": {
                                    "type": "Allow"
                                },
                                "rules": []
                            },
                            {
                                "name": "Cu6-Network-Deny-RC",
                                "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                                "priority": 100,
                                "action": {
                                    "type": "Deny"
                                },
                                "rules": []
                            }
                        ]
                    }
                },
                {
                    "name": "DefaultDnatRuleCollectionGroup",
                    "properties": {
                        "priority": 700,
                        "ruleCollections": [
                            {
                                "ruleCollectionType": "FirewallPolicyNatRuleCollection",
                                "action": {
                                    "type": "Dnat"
                                },
                                "rules": [
                                    {
                                        "ruleType": "NatRule",
                                        "name": "AllowRDP",
                                        "translatedAddress": "192.168.0.1",
                                        "translatedPort": "3389",
                                        "ipProtocols": [
                                            "TCP",
                                            "UDP"
                                        ],
                                        "sourceAddresses": [
                                            "192.168.0.1"
                                        ],
                                        "sourceIpGroups": [],
                                        "destinationAddresses": [
                                            "20.166.1.109"
                                        ],
                                        "destinationPorts": [
                                            "3389"
                                        ]
                                    }
                                ],
                                "name": "AllowRDP",
                                "priority": 700
                            }
                        ]
                    }
                }
            ]
        }
    }
}
```

</details>
</p>



## Outputs

None.
