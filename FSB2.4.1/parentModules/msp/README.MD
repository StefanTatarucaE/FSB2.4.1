# Bootstrap Parent module

Azure Bicep parent module to deploy the MSP subscription resources (optional)

## Description

This parent module deploys the MSP subscription resources for customers with their Azure estate managed through Azure Lighthouse.

The module calls the following child modules:
- Log Analytics Workspace (childModules/workspace/workspace.bicep)
- Azure Monitor Action Group (childModules/actionGroup/actionGroup.bicep)
- Azure Active Directory diagnostic settings (childModules/aadDiagnosticsEnable/aadDiagnostics.bicep)
- Core policies modules (cisAuditDeny, iso27001AuditDeny, mcsbAuditDeny)
- Scheduled Query module (childModules/scheduledQueryRule/scheduledQueryRule.bicep)

### Naming convention module 

The names used by the deployment are generated by the naming helper module, called before the MSP parent module in a powershell script (exceptionally for the MSP subscription, to allow the automatic deployment of Azure AD diagnostic settings resource, which requires a global admin context)

### Note about dataRetentionDefault value

The diagnosticrules for EvidenManaged resources are configured to send resource & activity logs to the log analytics workspace. Not every resource usage scenario can be predicted. As a consequence of that it's impossible to estimate the cost for Log Analytics Workspace ingestion and Log Analytics Workspace retention.

Make sure to implement budget Alerts using the cost management module to use as an early warning method to be informed about unexpected costs related to data ingestion and subsequently data retention.

The "dataRetentionDefault" is the setting which is used for indicating the "interactive retention time" period. This is the period in which the data can be used for interactive queries (reports, alerts). One can override this "interactive retention time" per table and one can also set an archival retention period in case logs need to be archived longer but are actually not needed for interactive queries.

Read more about the difference between "interactive retention" & archival retention: https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-retention-archive?tabs=portal-1%2Cportal-2

Overriding the global interactive retention time and setting an archival retention time per table can be done by populating the "setRetentionDays" array in the monitoring's input file.

## Parent module overview

The parent module creates the following resources:

- A resource group for the resource(s).
- A Log Analytics Workspace.
- An empty Azure Monitor Action Group that can be configured later for e-mail alerting and notifications
- Core Policies: CIS 1.3.0 initiative, ISO 27001 initiative and Microsoft cloud security benchmark initiative
- A set of scheduled query alerts related to Azure Active Directory:
    - User login failed 5 Attempts with same user account
    - User login failed 5 Attempts with same IP address
    - Add member to Subscription Owner group
    - Add member to limited Administrator role Security Administrator (Directory)
    - Add member to global Administrator role (Directory)

The deployment is initiated by a powershell script (<Repository root>\scripts\Deploy-MspSubscriptionComponents.ps1) 
This script isdeploys the naming module first, then it deploys the msp module using the names from the json file generated by the naming module.

### Parent module parameters

**Required parameters**

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `monitoringWorkspaceSkuName` | `string` | Specifies the SKU for the Log Analytics Workspace. |
| `dataRetentionDefault` | `int` | Specifies the number of days to retain the logs. Increasing the value increases the cost. |
| `deployCis` | `bool` | Specifies if the CIS Azure Foundations Benchmark 1.3.0 policy initiative should be deployed. |
| `cisAuditDenySettings` | `object` | true | Object which sets the values for the policy assignment parameters. |
| `iso27001AuditDenySettings` | `object` | true | Object which sets the values for the policy assignment parameters. |
| `mcsbAuditDenySettings` | `object` | true | Object which sets the values for the policy assignment parameters. |
| `deployIso20071` | `bool` | Specifies if the ISO 27001 policy initiative should be deployed. |
| `deploySecurityBenchmark` | `bool` | Specifies if the Microsoft cloud security benchmark initiative should be deployed. |

**Optional parameters**

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `additionalMonitoringTags` | `object` | `{}` | A mapping of additional tags to be assigned to the Log Analytics Workspace resource and its parent resource group. |


## Example parameters file

The required values for parameters are described in the following example of a parameters file.
The values for the **required** parameters **must** be defined for the parent module to run successfully.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "monitoringWorkspaceSkuName": {
      "value": "PerGB2018"
    },
    "dataRetentionDefault": {
      "value": 31
    },
        "setRetentionDays": {
      "value": [
        {
          "name": "AzureActivity",
          "retentionInDays": 90,
          "totalRetentionInDays": 365
        }
      ]
    },
    "deployCis": {
      "value": true
    },
    "deployIso20071": {
      "value": true
    },
    "deploySecurityBenchmark": {
      "value": true
    },
    "cisAuditDenySettings": {
      "value": {
        "virtualMachineExtensionsAllowed": [
          "AzureDiskEncryption"
        ],
        "effectVirtualMachineExtensionsAllowed": "Audit",
        "resourceLogsRequiredRetentionDays": "160",
        "defenderForServersEnabled": "AuditIfNotExists",
        "defenderForAppServiceEnabled": "AuditIfNotExists",
        "defenderForSqlDbEnabled": "AuditIfNotExists",
        "defenderForSqlServerEnabled": "AuditIfNotExists",
        "defenderForStorageEnabled": "AuditIfNotExists",
        "defenderForContainersEnabled": "AuditIfNotExists",
        "defenderForKeyvaultsEnabled": "AuditIfNotExists",
        "autoProvisionLaAgentEnabled": "AuditIfNotExists",
        "subscriptionSecurityContact": "AuditIfNotExists",
        "emailHighSeverityAlert": "AuditIfNotExists",
        "secureTransferStorageAccount": "Audit",
        "storagePublicAccessDisallowed": "Audit",
        "storageAccountRestrictNetworkAccess": "Audit",
        "storageAccountRestrictNetworkAccessVirtualNetworkRules": "Audit",
        "storageAccountAllowTrustedMsServices": "Audit",
        "storageAccountCmkForEncryption": "Audit",
        "auditSqlEnabled": "AuditIfNotExists",
        "tdeOnSqlEnabled": "AuditIfNotExists",
        "sqlServerAuditLogRetention": "AuditIfNotExists",
        "defenderForSqlOnUnprotectedSqlServersEnabled": "AuditIfNotExists",
        "defenderForSqlOnUnprotectedSqlMiEnabled": "AuditIfNotExists",
        "vulnerabilityAssessmentEnabledOnSqlServers": "AuditIfNotExists",
        "vulnerabilityAssessmentEnabledOnMiInstances": "AuditIfNotExists",
        "enforcedSslEnabledPostgresSql": "Audit",
        "enabledLogCheckpointsPostgresSql": "AuditIfNotExists",
        "enabledLogConnectionsPostgresSql": "AuditIfNotExists",
        "enabledLogDisconnectionsPostgresSql": "AuditIfNotExists",
        "enabledConnectionThrottlingPostgresSql": "AuditIfNotExists",
        "azureAdAdminShouldbeProvisionForSqlServer": "AuditIfNotExists",
        "sqlServersShouldUseCmkAtRest": "Audit",
        "sqlMiShouldUseCmkAtRest": "Audit",
        "storageAccountWithActivityLogsShouldUseCmk": "AuditIfNotExists",
        "resourceLogsInKeyvaultsEnabled": "AuditIfNotExists",
        "activityLogAlertForPolicyWrite": "AuditIfNotExists",
        "activityLogAlertForPolicyDelete": "AuditIfNotExists",
        "activityLogAlertForNsgWrite": "AuditIfNotExists",
        "activityLogAlertForNsgDelete": "AuditIfNotExists",
        "activityLogAlertForNsgRuleWrite": "AuditIfNotExists",
        "activityLogAlertForNsgRuleDelete": "AuditIfNotExists",
        "activityLogAlertForFirewallRulesWrite": "AuditIfNotExists",
        "activityLogAlertForFirewallRulesDelete": "AuditIfNotExists",
        "appServiceResourceLogsEnabled": "AuditIfNotExists",
        "batchAccountsResourceLogsEnabled": "AuditIfNotExists",
        "azureDatalakeStoreResourceLogsEnabled": "AuditIfNotExists",
        "dataLakeAnalyticsResourceLogsEnabled": "AuditIfNotExists",
        "eventHubsResourceLogsEnabled": "AuditIfNotExists",
        "iotHubResourceLogsEnabled": "AuditIfNotExists",
        "logicAppResourceLogsEnabled": "AuditIfNotExists",
        "searchServicesResourceLogsEnabled": "AuditIfNotExists",
        "serviceBusResourceLogsEnabled": "AuditIfNotExists",
        "streamAnalyticsResourceLogsEnabled": "AuditIfNotExists",
        "encryptDataFlowsBetweenComputeAndStorage": "AuditIfNotExists",
        "keyVaultKeysShouldHaveExpiration": "Audit",
        "keyVaultSecretsShouldHaveExpiration": "Audit",
        "keyvaultPurgeProtectionEnabled": "Audit",
        "functionAppsAuthenticationEnabled": "AuditIfNotExists",
        "appServicesAuthenticationEnabled": "AuditIfNotExists",
        "appServiceAccessibleOverHttps": "Audit",
        "functionAppsLatestTlsVersion": "AuditIfNotExists",
        "appServiceAppsLatestTlsVersion": "AuditIfNotExists",
        "functionAppsClientCertificatesEnabled": "Audit",
        "appServiceAppsClientCertificatesEnabled": "Audit",
        "functionAppShouldUseManagedIdentity": "AuditIfNotExists",
        "appServiceAppShouldUseManagedIdentity": "AuditIfNotExists",
        "functionAppShouldUseLatestHttpVersion": "AuditIfNotExists",
        "appServiceAppShouldUseLatestHttpVersion": "AuditIfNotExists",
        "functionAppShouldRequireFtpsOnly": "AuditIfNotExists",
        "appServiceAppShouldRequireFtpsOnly": "AuditIfNotExists",
        "networkWatcherShouldBeEnabled": "NetworkWatcherRG",
        "requiredAuditSettingsforSqlServers": "disabled",
        "guestOwnerPermissionRemoved": "AuditIfNotExists",
        "guestWritePermissionRemoved": "AuditIfNotExists",
        "guestReadPermissionRemoved": "AuditIfNotExists",
        "mfaWithWritePermissionEnabled": "AuditIfNotExists",
        "maximumDaysToRotateKeys":"Audit",
        "maximumDaysToRotate":30,
        "mfaWithOwnerPermissionEnabled": "AuditIfNotExists"

      }
    },
    "mcsbAuditDenySettings": {
      "value": {
        "installLogAnalyticsAgentOnVmMonitoringEffect": "AuditIfNotExists",
        "installLogAnalyticsAgentOnVmssMonitoringEffect": "AuditIfNotExists",
        "certificatesValidityPeriodMonitoringEffect": "disabled",
        "certificatesValidityPeriodInMonths": 12,
        "secretsExpirationSetEffect": "Disabled",
        "keysExpirationSetEffect": "Disabled",
        "azurePolicyforWindowsMonitoringEffect": "AuditIfNotExists",
        "gcExtOnVmWithNoSamiMonitoringEffect": "AuditIfNotExists",
        "windowsDefenderExploitGuardMonitoringEffect": "AuditIfNotExists",
        "windowsGuestConfigBaselinesMonitoringEffect": "AuditIfNotExists",
        "linuxGuestConfigBaselinesMonitoringEffect": "AuditIfNotExists",
        "vmssSystemUpdatesMonitoringEffect": "AuditIfNotExists",
        "vmssEndpointProtectionMonitoringEffect": "AuditIfNotExists",
        "vmssOsVulnerabilitiesMonitoringEffect": "AuditIfNotExists",
        "systemUpdatesMonitoringEffect": "AuditIfNotExists",
        "systemUpdatesV2MonitoringEffect": "AuditIfNotExists",
        "systemUpdatesAutoAssessmentModeEffect": "Audit",
        "systemConfigurationsMonitoringEffect": "AuditIfNotExists",
        "endpointProtectionMonitoringEffect": "AuditIfNotExists",
        "diskEncryptionMonitoringEffect": "AuditIfNotExists",
        "gcLinuxDiskEncryptionMonitoringEffect": "AuditIfNotExists",
        "gcWindowsDiskEncryptionMonitoringEffect": "AuditIfNotExists",
        "networkSecurityGroupsOnSubnetsMonitoringEffect": "Disabled",
        "networkSecurityGroupsOnVirtualMachinesMonitoringEffect": "AuditIfNotExists",
        "networkSecurityGroupsOnInternalVirtualMachinesMonitoringEffect": "AuditIfNotExists",
        "nextGenerationFirewallMonitoringEffect": "AuditIfNotExists",
        "serverVulnerabilityAssessmentEffect": "AuditIfNotExists",
        "jitNetworkAccessMonitoringEffect": "AuditIfNotExists",
        "adaptiveApplicationControlsMonitoringEffect": "AuditIfNotExists",
        "adaptiveApplicationControlsUpdateMonitoringEffect": "AuditIfNotExists",
        "sqlDbEncryptionMonitoringEffect": "AuditIfNotExists",
        "sqlServerAuditingMonitoringEffect": "AuditIfNotExists",
        "encryptionOfAutomationAccountMonitoringEffect": "Audit",
        "diagnosticsLogsInBatchAccountMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInBatchAccountRetentionDays": "1",
        "classicComputeVmsMonitoringEffect": "Audit",
        "classicStorageAccountsMonitoringEffect": "Audit",
        "diagnosticsLogsInDataLakeAnalyticsMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInDataLakeAnalyticsRetentionDays": "1",
        "diagnosticsLogsInDataLakeStoreMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInDataLakeStoreRetentionDays": "1",
        "diagnosticsLogsInEventHubMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInEventHubRetentionDays": "1",
        "diagnosticsLogsInKeyVaultMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInKeyVaultRetentionDays": "1",
        "diagnosticsLogsInKubernetesMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInKubernetesRetentionDays": "1",
        "diagnosticsLogsInLogicAppsMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInLogicAppsRetentionDays": "1",
        "diagnosticsLogsInRedisCacheMonitoringEffect": "Audit",
        "diagnosticsLogsInSearchServiceMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInSearchServiceRetentionDays": "1",
        "aadAuthenticationInServiceFabricMonitoringEffect": "Audit",
        "clusterProtectionLevelInServiceFabricMonitoringEffect": "Audit",
        "diagnosticsLogsInServiceBusMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInServiceBusRetentionDays": "1",
        "aadAuthenticationInSqlServerMonitoringEffect": "AuditIfNotExists",
        "secureTransferToStorageAccountMonitoringEffect": "Audit",
        "diagnosticsLogsInStreamAnalyticsMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInStreamAnalyticsRetentionDays": "1",
        "useRbacRulesMonitoringEffect": "Audit",
        "disableUnrestrictedNetworkToStorageAccountMonitoringEffect": "Disabled",
        "sqlDbVulnerabilityAssesmentMonitoringEffect": "AuditIfNotExists",
        "serverSqlDbVulnerabilityAssesmentMonitoringEffect": "AuditIfNotExists",
        "identityDesignateLessThanOwnersMonitoringEffect": "AuditIfNotExists",
        "identityDesignateMoreThanOneOwnerMonitoringEffect": "AuditIfNotExists",
        "identityEnableMfaForOwnerPermissionsMonitoringEffect": "AuditIfNotExists",
        "identityEnableMfaForWritePermissionsMonitoringEffect": "AuditIfNotExists",
        "identityEnableMfaForReadPermissionsMonitoringEffect": "AuditIfNotExists",
        "identityRemoveExternalAccountWithOwnerPermissionsMonitoringEffect": "AuditIfNotExists",
        "identityRemoveExternalAccountWithWritePermissionsMonitoringEffect": "AuditIfNotExists",
        "identityRemoveExternalAccountWithReadPermissionsMonitoringEffect": "AuditIfNotExists",
        "functionAppDisableRemoteDebuggingMonitoringEffect": "AuditIfNotExists",
        "webAppDisableRemoteDebuggingMonitoringEffect": "AuditIfNotExists",
        "functionAppEnforceHttpsMonitoringEffectV2": "Audit",
        "webAppEnforceHttpsMonitoringEffectV2": "Audit",
        "functionAppRestrictCorsAccessMonitoringEffect": "AuditIfNotExists",
        "webAppRestrictCorsAccessMonitoringEffect": "AuditIfNotExists",
        "vnetEnableDdoSProtectionMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInIotHubMonitoringEffect": "AuditIfNotExists",
        "diagnosticsLogsInIotHubRetentionDays": "1",
        "sqlServerAdvancedDataSecurityMonitoringEffect": "AuditIfNotExists",
        "arcEnabledSqlServerDefenderStatusEffect": "Audit",
        "sqlManagedInstanceAdvancedDataSecurityMonitoringEffect": "AuditIfNotExists",
        "kubernetesServiceRbacEnabledMonitoringEffect": "Audit",
        "kubernetesServiceAuthorizedIpRangesEnabledMonitoringEffect": "Audit",
        "vulnerabilityAssessmentOnManagedInstanceMonitoringEffect": "AuditIfNotExists",
        "vulnerabilityAssessmentOnServerMonitoringEffect": "AuditIfNotExists",
        "adaptiveNetworkHardeningsMonitoringEffect": "AuditIfNotExists",
        "restrictAccessToManagementPortsMonitoringEffect": "AuditIfNotExists",
        "disableIpForwardingMonitoringEffect": "AuditIfNotExists",
        "ensureServerTdeIsEncryptedWithYourOwnKeyWithDenyMonitoringEffect": "Disabled",
        "ensureManagedInstanceTdeIsEncryptedWithYourOwnKeyWithDenyMonitoringEffect": "Disabled",
        "containerBenchmarkMonitoringEffect": "AuditIfNotExists",
        "ascDependencyAgentAuditWindowsEffect": "AuditIfNotExists",
        "ascDependencyAgentAuditLinuxEffect": "AuditIfNotExists",
        "azureFirewallEffect": "AuditIfNotExists",
        "arcWindowsMonitoringEffect": "AuditIfNotExists",
        "arcLinuxMonitoringEffect": "AuditIfNotExists",
        "keyVaultsAdvancedDataSecurityMonitoringEffect": "AuditIfNotExists",
        "sqlServersAdvancedDataSecurityMonitoringEffect": "AuditIfNotExists",
        "sqlServersVirtualMachinesAdvancedDataSecurityMonitoringEffect": "AuditIfNotExists",
        "appServicesAdvancedThreatProtectionMonitoringEffect": "AuditIfNotExists",
        "containersAdvancedThreatProtectionMonitoringEffect": "AuditIfNotExists",
        "virtualMachinesAdvancedThreatProtectionMonitoringEffect": "AuditIfNotExists",
        "azurePolicyAddonStatusEffect": "Audit",
        "arcEnabledKubernetesClustersShouldHaveAzurePolicyExtensionInstalledEffect": "AuditIfNotExists",
        "excludedImagesInKubernetesCluster": [],
        "allowedContainerImagesInKubernetesClusterEffect": "Audit",
        "allowedContainerImagesInKubernetesClusterRegex": "^(.+){0}$",
        "allowedContainerImagesNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "privilegedContainersShouldBeAvoidedEffect": "Audit",
        "privilegedContainerNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "allowedServicePortsInKubernetesClusterEffect": "Audit",
        "allowedservicePortsInKubernetesClusterPorts": [],
        "allowedServicePortsInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc"
        ],
        "noPrivilegeEscalationInKubernetesClusterEffect": "Audit",
        "noPrivilegeEscalationInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc"
        ],
        "noSharingSensitiveHostNamespacesInKubernetesEffect": "Audit",
        "noSharingSensitiveHostNamespacesInKubernetesNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc"
        ],
        "readOnlyRootFileSystemInKubernetesClusterEffect": "Audit",
        "readOnlyRootFileSystemInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "allowedCapabilitiesInKubernetesClusterEffect": "Audit",
        "allowedCapabilitiesInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "allowedCapabilitiesInKubernetesClusterList": [],
        "dropCapabilitiesInKubernetesClusterList": [],
        "allowedAppArmorProfilesInKubernetesClusterEffect": "Audit",
        "allowedAppArmorProfilesInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "allowedAppArmorProfilesInKubernetesClusterList": [
          "runtime/default"
        ],
        "allowedHostNetworkingAndPortsInKubernetesClusterEffect": "Audit",
        "allowedHostNetworkingAndPortsInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc"
        ],
        "allowHostNetworkingInKubernetesCluster": false,
        "allowedHostMinPortInKubernetesCluster": 0,
        "allowedHostMaxPortInKubernetesCluster": 0,
        "allowedHostPathVolumesInKubernetesClusterEffect": "Audit",
        "allowedHostPathVolumesInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "allowedHostPathVolumesInKubernetesClusterList": {
          "paths": []
        },
        "memoryAndCpuLimitsInKubernetesClusterEffect": "Audit",
        "memoryInKubernetesClusterLimit": "64Gi",
        "cpuInKubernetesClusterLimit": "32",
        "memoryAndCpuLimitsInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "blockVulnerableImagesInKubernetesClusterEffect": "Disabled",
        "blockVulnerableImagesInKubernetesClusterNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc"
        ],
        "blockVulnerableImagesExcludedImages": [],
        "blockVulnerableImagesSeverityThresholdForExcludingNotPatchableFindings": "None",
        "blockVulnerableImagesExcludeFindingIDs": [],
        "severity": {
          "High": 0,
          "Medium": 0,
          "Low": 0
        },
        "mustRunAsNonRootNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "mustRunAsNonRootNamespaceEffect": "Audit",
        "arcEnabledKubernetesClustersShouldHaveAzureDefendersExtensionInstalled": "AuditIfNotExists",
        "azureKubernetesServiceClustersShouldHaveSecurityProfileEnabled": "Audit",
        "containerRegistryVulnerabilityAssessmentEffect": "AuditIfNotExists",
        "kubernetesRunningImagesVulnerabilityAssessmentEffect": "AuditIfNotExists",
        "disallowPublicBlobAccessEffect": "audit",
        "azureBackupShouldBeEnabledForVirtualMachinesMonitoringEffect": "AuditIfNotExists",
        "managedIdentityShouldBeUsedInYourFunctionAppMonitoringEffect": "AuditIfNotExists",
        "georedundantBackupShouldBeEnabledForAzureDatabaseForMariadbMonitoringEffect": "Audit",
        "managedIdentityShouldBeUsedInYourWebAppMonitoringEffect": "AuditIfNotExists",
        "geoRedundantBackupShouldBeEnabledForAzureDatabaseForPostgresqlMonitoringEffect": "Audit",
        "ensureWebAppHasClientCertificatesIncomingClientCertificatesSetToOnMonitoringEffect": "Audit",
        "geoRedundantBackupShouldBeEnabledForAzureDatabaseForMysqlMonitoringEffect": "Audit",
        "diagnosticLogsInAppServicesShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "enforceSslConnectionShouldBeEnabledForPostgresqlDatabaseServersMonitoringEffect": "Audit",
        "enforceSslConnectionShouldBeEnabledForMysqlDatabaseServersMonitoringEffect": "Audit",
        "latestTlsVersionShouldBeUsedInYourWebAppMonitoringEffect": "AuditIfNotExists",
        "latestTlsVersionShouldBeUsedInYourFunctionAppMonitoringEffect": "AuditIfNotExists",
        "privateEndpointShouldBeEnabledForPostgresqlServersMonitoringEffect": "AuditIfNotExists",
        "privateEndpointShouldBeEnabledForMariadbServersMonitoringEffect": "AuditIfNotExists",
        "privateEndpointShouldBeEnabledForMysqlServersMonitoringEffect": "AuditIfNotExists",
        "sqlServersShouldBeConfiguredWithAuditingRetentionDaysGreaterThan90DaysMonitoringEffect": "AuditIfNotExists",
        "ftpsOnlyShouldBeRequiredInYourFunctionAppMonitoringEffect": "AuditIfNotExists",
        "ftpsShouldBeRequiredInYourWebAppMonitoringEffect": "AuditIfNotExists",
        "functionAppsShouldHaveClientCertificatesEnabledMonitoringEffect": "Audit",
        "cognitiveServicesAccountsShouldEnableDataEncryptionWithACustomerManagedKeyMonitoringEffect": "Disabled",
        "azureCosmosDbAccountsShouldUseCustomerManagedKeysToEncryptDataAtRestMonitoringEffect": "disabled",
        "azureCosmosDbAccountsShouldHaveLocalAuthenticationMethodsDisabledMonitoringEffect": "Audit",
        "keyVaultsShouldHavePurgeProtectionEnabledMonitoringEffect": "Audit",
        "keyVaultsShouldHaveSoftDeleteEnabledMonitoringEffect": "Audit",
        "azureCacheForRedisShouldUsePrivateEndpointMonitoringEffect": "AuditIfNotExists",
        "storageAccountsShouldUseCustomerManagedKeyForEncryptionMonitoringEffect": "Disabled",
        "storageAccountsShouldRestrictNetworkAccessUsingVirtualNetworkRulesMonitoringEffect": "Audit",
        "containerRegistriesShouldBeEncryptedWithACustomerManagedKeyMonitoringEffect": "Disabled",
        "containerRegistriesShouldNotAllowUnrestrictedNetworkAccessMonitoringEffect": "Audit",
        "containerRegistriesShouldUsePrivateLinkMonitoringEffect": "Audit",
        "appConfigurationShouldUsePrivateLinkMonitoringEffect": "AuditIfNotExists",
        "azureEventGridDomainsShouldUsePrivateLinkMonitoringEffect": "Audit",
        "azureEventGridTopicsShouldUsePrivateLinkMonitoringEffect": "Audit",
        "azureSignalRServiceShouldUsePrivateLinkMonitoringEffect": "Audit",
        "azureMachineLearningWorkspacesShouldBeEncryptedWithACustomerManagedKeyMonitoringEffect": "Disabled",
        "azureMachineLearningWorkspacesShouldUsePrivateLinkMonitoringEffect": "Audit",
        "webApplicationFirewallShouldBeEnabledForAzureFrontDoorServiceServiceMonitoringEffect": "Audit",
        "webApplicationFirewallShouldBeEnabledForApplicationGatewayMonitoringEffect": "Audit",
        "publicNetworkAccessShouldBeDisabledForMariaDbServersMonitoringEffect": "Audit",
        "publicNetworkAccessShouldBeDisabledForMySqlServersMonitoringEffect": "Audit",
        "bringYourOwnKeyDataProtectionShouldBeEnabledForMySqlServersMonitoringEffect": "Disabled",
        "publicNetworkAccessShouldBeDisabledForPostgreSqlServersMonitoringEffect": "Audit",
        "bringYourOwnKeyDataProtectionShouldBeEnabledForPostgreSqlServersMonitoringEffect": "Disabled",
        "vmImageBuilderTemplatesShouldUsePrivateLinkMonitoringEffect": "Audit",
        "firewallShouldBeEnabledOnKeyVaultMonitoringEffect": "Audit",
        "privateEndpointShouldBeConfiguredForKeyVaultMonitoringEffect": "Audit",
        "azureSpringCloudShouldUseNetworkInjectionMonitoringEffect": "Audit",
        "subscriptionsShouldHaveAContactEmailAddressForSecurityIssuesMonitoringEffect": "AuditIfNotExists",
        "autoProvisioningOfTheLogAnalyticsAgentShouldBeEnabledOnYourSubscriptionMonitoringEffect": "AuditIfNotExists",
        "emailNotificationForHighSeverityAlertsShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "emailNotificationToSubscriptionOwnerForHighSeverityAlertsShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "storageAccountShouldUseAPrivateLinkConnectionMonitoringEffect": "AuditIfNotExists",
        "authenticationToLinuxMachinesShouldRequireSshKeysMonitoringEffect": "AuditIfNotExists",
        "privateEndpointConnectionsOnAzureSqlDatabaseShouldBeEnabledMonitoringEffect": "Audit",
        "publicNetworkAccessOnAzureSqlDatabaseShouldBeDisabledMonitoringEffect": "Audit",
        "kubernetesClustersShouldBeAccessibleOnlyOverHttpsMonitoringEffect": "Audit",
        "kubernetesClustersShouldBeAccessibleOnlyOverHttpsExcludedNamespaces": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc"
        ],
        "kubernetesClustersShouldBeAccessibleOnlyOverHttpsNamespaces": [],
        "windowsWebServersShouldBeConfiguredToUseSecureCommunicationProtocolsMonitoringEffect": "AuditIfNotExists",
        "windowsWebServersShouldBeConfiguredToUseSecureCommunicationProtocolsIncludeArcMachines": "true",
        "windowsWebServersShouldBeConfiguredToUseSecureCommunicationProtocolsMinimumTLSVersion": "1.2",
        "cognitiveServicesAccountsShouldRestrictNetworkAccessMonitoringEffect": "Audit",
        "publicNetworkAccessShouldBeDisabledForCognitiveServicesAccountsMonitoringEffect": "Audit",
        "apiManagementServicesShouldUseAVirtualNetworkMonitoringEffect": "Audit",
        "apiManagementServicesShouldUseAVirtualNetworkEvaluatedSkuNames": [
          "Developer",
          "Premium"
        ],
        "azureCosmosDbaccountsShouldHaveFirewallRulesMonitoringEffect": "Audit",
        "networkWatcherShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "networkWatcherShouldBeEnabledResourceGroupName": "NetworkWatcherRG",
        "azureDefenderForResourceManagerShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "azureDefenderForDnsShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "azureDefenderForOpenSourceRelationalDatabasesShouldBeEnabledMonitoringEffect": "AuditIfNotExists",
        "microsoftDefenderCspmShouldBeEnabledMonitoringEffect": "Disabled",
        "KubernetesClustersShouldNotUseTheDefaultNamespaceMonitoringEffect": "Audit",
        "KubernetesClustersShouldDisableAutomountingApiCredentialsMonitoringEffect": "Audit",
        "KubernetesClustersShouldDisableAutomountingApiCredentialsMonitoringNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "KubernetesClustersShouldNotGrantCapsysadminSecurityCapabilitiesMonitoringEffect": "Audit",
        "KubernetesClustersShouldNotGrantCapsysadminSecurityCapabilitiesMonitoringNamespaceExclusion": [
          "kube-system",
          "gatekeeper-system",
          "azure-arc",
          "azuredefender",
          "mdc"
        ],
        "vtpmShouldBeEnabledOnSupportedVirtualMachinesMonitoringEffect": "Audit",
        "secureBootShouldBeEnabledOnSupportedWindowsVirtualMachinesMonitoringEffect": "Audit",
        "guestAttestationExtensionShouldBeInstalledOnSupportedLinuxVirtualMachinesMonitoringEffect": "AuditIfNotExists",
        "guestAttestationExtensionShouldBeInstalledOnSupportedLinuxVirtualMachinesScaleSetsMonitoringEffect": "AuditIfNotExists",
        "guestAttestationExtensionShouldBeInstalledOnSupportedWindowsVirtualMachinesMonitoringEffect": "AuditIfNotExists",
        "guestAttestationExtensionShouldBeInstalledOnSupportedWindowsVirtualMachinesScaleSetsMonitoringEffect": "AuditIfNotExists",
        "installEndpointProtectionMonitoringEffect": "AuditIfNotExists",
        "endpointProtectionHealthIssuesMonitoringEffect": "AuditIfNotExists"
      }
    },
    "iso27001AuditDenySettings": {
      "value": {
        "includeArcMachines": "false",
        "includeMetricsDiagnosticLogging": true,
        "includeLogsDiagnosticLogging": true,
        "listOfResourceTypesWithDiagnosticLogsEnabled": [
          "Microsoft.AnalysisServices/servers",
          "Microsoft.ApiManagement/service",
          "Microsoft.Network/applicationGateways",
          "Microsoft.Automation/automationAccounts",
          "Microsoft.ContainerInstance/containerGroups",
          "Microsoft.ContainerRegistry/registries",
          "Microsoft.ContainerService/managedClusters",
          "Microsoft.Batch/batchAccounts",
          "Microsoft.Cdn/profiles/endpoints",
          "Microsoft.CognitiveServices/accounts",
          "Microsoft.DocumentDB/databaseAccounts",
          "Microsoft.DataFactory/factories",
          "Microsoft.DataLakeAnalytics/accounts",
          "Microsoft.DataLakeStore/accounts",
          "Microsoft.EventGrid/topics",
          "Microsoft.EventHub/namespaces",
          "Microsoft.Network/expressRouteCircuits",
          "Microsoft.Network/azureFirewalls",
          "Microsoft.HDInsight/clusters",
          "Microsoft.Devices/IotHubs",
          "Microsoft.KeyVault/vaults",
          "Microsoft.Network/loadBalancers",
          "Microsoft.Logic/integrationAccounts",
          "Microsoft.Logic/workflows",
          "Microsoft.DBforMySQL/servers",
          "Microsoft.Network/networkInterfaces",
          "Microsoft.Network/networkSecurityGroups",
          "Microsoft.DBforPostgreSQL/servers",
          "Microsoft.PowerBIDedicated/capacities",
          "Microsoft.Network/publicIPAddresses",
          "Microsoft.RecoveryServices/vaults",
          "Microsoft.Cache/redis",
          "Microsoft.Relay/namespaces",
          "Microsoft.Search/searchServices",
          "Microsoft.ServiceBus/namespaces",
          "Microsoft.SignalRService/SignalR",
          "Microsoft.Sql/servers/databases",
          "Microsoft.Sql/servers/elasticPools",
          "Microsoft.StreamAnalytics/streamingjobs",
          "Microsoft.TimeSeriesInsights/environments",
          "Microsoft.Network/trafficManagerProfiles",
          "Microsoft.Compute/virtualMachines",
          "Microsoft.Compute/virtualMachineScaleSets",
          "Microsoft.Network/virtualNetworks",
          "Microsoft.Network/virtualNetworkGateways"
        ]
      }
    }
  }
}
```

## ELZ Azure Configuration Values

The folder of the parent module contains a `parentModuleConfig.json` file. This json file contains the recommended values for some additional parameters required by the child modules this parent module is calling.

The `parentModuleConfig.json` file is referenced by the parent module in a 'parentModuleConfig' variable; `var parentModuleConfig = loadJsonContent('parentModuleConfig.json')`.

Description of the configuration defaults:

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `monitoringWorkspacePublicNetworkAccess` | `object` | `{"forIngestion": "Enabled", "forQuery": "Enabled"}` | Default values, forIngestion has no impact if disabled, forQuery would break the alerting if disabled and there is no Private Link Scope defined (https://learn.microsoft.com/en-us/azure/azure-monitor/logs/private-link-security#configure-access-to-your-resources). |
| `datasources` | `array` | `[]` | No datasources are required for the ELZ purpose of the MSP Log Analytics Workspace. |
| `solutions` | `array` | `[]` | No datasources are required for the ELZ purpose of the MSP Log Analytics Workspace. |
| `aadLogsProperties` | `array` | `Check the parentModuleConfig.json file` | Default value ensures that all Azure Active Directory log categories are sent to the Log Analytics Workspace with an indefinite retention period. |
| `cisPolicyDefinitionId` | `string` | `/providers/Microsoft.Authorization/policySetDefinitions/06f19060-9e68-4070-92ca-f15cc126059e` | Holds the policy definition id of the built-in CIS Initiative. | v2.0.0 |
| `isoPolicyDefinitionId` | `string` | `/providers/Microsoft.Authorization/policySetDefinitions/89c6cddc-1c73-4ac1-b19c-54d1a15a42f2` | Holds the policy definition id of the built-in ISO Initiative. | ISO 27001:2013 | 
| `mcsbPolicyDefinitionId` | `string` | `/providers/Microsoft.Authorization/policySetDefinitions/1f3afdf9-d0c9-4c3d-847f-89da613e70a8` | Holds the policy definition id of the built-in MCSB Initiative. | MCSB > v57.1.0 |
| `nistPolicyDefinitionId` | `string` | `/providers/Microsoft.Authorization/policySetDefinitions/03055927-78bd-4236-86c0-f36125a10dc9` | Holds the policy definition id of the built-in ISO Initiative. | NIST SP 800-171 Rev. 2 | 

> **Note**
> 
> It is recommended to only change these values after consulting the Microsoft documentation and the ELZ Azure engineering team.
## Outputs

None.