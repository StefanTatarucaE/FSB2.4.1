{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Azure  PIM role Assignment overview ##"
      },
      "name": "text - 1"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "26d3476e-f51d-4d0b-aa4c-7966371ec1c2",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "value": {
              "durationMs": 172800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "205f9c51-0312-4444-a0ed-c82c1b472d69",
            "version": "KqlParameterItem/1.0",
            "name": "LAWorkspace",
            "type": 5,
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where (tostring(tags) has ('\"[parameter(tagPrefix)]LogAnalytics\"')) or (tostring(tags) has ('\"[parameter(tagValuePrefix)]Monitoring\"'))\r\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::1",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "56d51e1c-944d-4742-a6d6-36dcd8e637dc",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resourcecontainers\r\n| where type == \"microsoft.resources/subscriptions\"\r\n| project subscriptionId, name\r\n//| distinct name, subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "value": [
              "value::all"
            ],
            "typeSettings": {
              "limitSelectTo": 100,
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "c7d5fa72-774c-47e6-b9a8-7af88907c168",
            "version": "KqlParameterItem/1.0",
            "name": "OperationName",
            "label": "Operation Name",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "jsonData": "[\"Delete role assignment\", \"Create role assignment\"]",
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "a87712dd-d269-40d6-bc9e-22f231dd5d32",
            "version": "KqlParameterItem/1.0",
            "name": "Role",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "value": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "jsonData": "[\"Contributor\", \"Resource Policy Contributor\", \"Blueprint Operator\", \"Managed Services Registration Assignment Delete Role\", \"Unknown\"]",
            "defaultValue": "value::all"
          },
          {
            "id": "f2855fe9-99a5-4901-88fe-c9e7b56c192a",
            "version": "KqlParameterItem/1.0",
            "name": "Username",
            "label": "User Name",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "let timeRangeStart = {TimeRange:start};\r\nlet timeRangeEnd = {TimeRange:end};\r\nAzureActivity \r\n| where TimeGenerated > timeRangeStart and TimeGenerated < timeRangeEnd\r\n| where tostring(Authorization) contains \"PIM Contributor\" and (OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/DELETE\" or OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/WRITE\")\r\n| extend Subscription = Hierarchy\r\n| extend p=parse_json(Properties)\r\n| extend pp = iif((OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/DELETE\"), p.responseBody, p.requestbody)\r\n| extend ppp = iif((OperationNameValue contains \"Delete\"),split(tostring(pp),\",\")[1], split(tostring(pp),\",\")[2])\r\n| extend UserId = iif((OperationNameValue contains \"Delete\"),split(ppp,\"\\\"principalId\\\":\")[1], split(ppp,\"\\\"PrincipalId\\\":\")[1])\r\n| extend UserId=replace_string(tostring(UserId), '-', '')\r\n| join kind=leftouter (\r\nAzureActivity \r\n| where Caller contains \"@\"\r\n| where  Authorization contains \"principalId\" and Authorization contains \"User\"\r\n| extend Subscription = split (_ResourceId,\"/\")[2]\r\n| extend UserName=Caller\r\n| extend p=parse_json(Authorization)\r\n| extend Id = tostring(split(p,\",\")[6])\r\n| extend UserId = tostring(split(Id, \"\\\"principalId\\\":\")[1])\r\n| project UserId, UserName\r\n| distinct  UserId, UserName\r\n) on UserId\r\n| extend UserName = iif(UserName == \"\", \"No Actions performed - UserName cannot be retrieved\", UserName)\r\n| where Subscription in ({Subscription})\r\n| project UserId, UserName\r\n| distinct  UserName",
            "crossComponentResources": [
              "{LAWorkspace}"
            ],
            "value": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "e7b8dfbf-54d1-4938-9292-c575e3650c80",
            "version": "KqlParameterItem/1.0",
            "name": "Scope",
            "label": "Scope of role assignment",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "jsonData": "[\"Subscription\", \"ResourceGroup\", \"Resource\", \"-\"]",
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "parameters - 2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let timeRangeStart = {TimeRange:start};\r\nlet timeRangeEnd = {TimeRange:end};\r\nAzureActivity \r\n| where TimeGenerated > timeRangeStart and TimeGenerated < timeRangeEnd\r\n| where tostring(Authorization) contains \"PIM Contributor\" and (OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/DELETE\" or OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/WRITE\")\r\n| extend Subscription = Hierarchy\r\n| extend OperationName = iif((OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/DELETE\"), \"Delete role assignment\", \"Create role assignment\")\r\n| extend p=parse_json(Properties)\r\n| extend pp = iif((OperationNameValue == \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/DELETE\"), p.responseBody, p.requestbody)\r\n| extend Role = iif((pp contains \"b24988ac-6180-42a0-ab88-20f7382dd24c\"), \"Contributor\", \"Unknown\") \r\n| extend Role = iif((pp contains \"36243c78-bf99-498c-9df9-86d9f8d28608\"), \"Resource Policy Contributor\", Role) \r\n| extend Role = iif((pp contains \"437d2ced-4a38-4302-8479-ed2bcb43d090\"), \"Blueprint Operator\", Role) \r\n| extend Role = iif((pp contains \"91c1777a-f3dc-4fae-b103-61d183457e46\"), \"Managed Services Registration Assignment Delete Role\", Role)\r\n| extend ppp = iif((OperationNameValue contains \"Delete\"),split(tostring(pp),\",\")[1], split(tostring(pp),\",\")[2])\r\n| extend DetectScope = split(split(pp,\"\\\"Scope\\\":\")[1],\",\")[0]\r\n| extend Scope = iif((DetectScope contains \"/resourceGroups/\"), \"ResourceGroup\", \"Subscription\")\r\n| extend Scope = iif((DetectScope contains \"/providers/\"), \"Resource\", Scope)\r\n| extend ResourceName = iif((DetectScope contains \"/resourceGroups/\"), split(DetectScope,\"/resourceGroups/\")[1], \"\")\r\n| extend ResourceName = iif((DetectScope contains \"/providers/\"), split(DetectScope,\"/providers/\")[1], ResourceName)\r\n| extend ResourceName = replace_string(tostring(ResourceName), '\\\"', '')\r\n| extend ResourceName = iif(Scope == \"Subscription\", Subscription, ResourceName)\r\n| extend Scope = iif((OperationNameValue contains \"Delete\"), \"-\", Scope)\r\n| extend ResourceName = iif((OperationNameValue contains \"Delete\"), \"-\", ResourceName)\r\n| extend UserId = iif((OperationNameValue contains \"Delete\"),split(ppp,\"\\\"principalId\\\":\")[1], split(ppp,\"\\\"PrincipalId\\\":\")[1])\r\n| extend UserId=replace_string(tostring(UserId), '-', '')\r\n| join kind=leftouter (\r\nAzureActivity \r\n| where Caller contains \"@\"\r\n| where  Authorization contains \"principalId\" and Authorization contains \"User\"\r\n| extend Subscription = split (_ResourceId,\"/\")[2]\r\n| extend UserName=Caller\r\n| extend p=parse_json(Authorization)\r\n| extend Id = tostring(split(p,\",\")[6])\r\n| extend UserId = tostring(split(Id, \"\\\"principalId\\\":\")[1])\r\n| project UserId, UserName\r\n| distinct  UserId, UserName\r\n) on UserId\r\n| extend UserName = iif(UserName == \"\", \"No Actions performed - UserName cannot be retrieved\", UserName)\r\n| where UserName in ({Username})\r\n| where Scope in ({Scope})\r\n| where UserId !=\"\"\r\n| where Role in ({Role})\r\n| where OperationName in ({OperationName})\r\n| where Subscription in ({Subscription})\r\n| project TimeGenerated, Subscription, OperationName, Role, UserName, UserId, Scope, ResourceName\r\n| sort by TimeGenerated desc",
        "size": 3,
        "noDataMessage": "No PIM role Assignment within time or selected filters",
        "timeContextFromParameter": "TimeRange",
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{LAWorkspace}"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Subscription",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "ResourceName",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true,
                "customColumnWidthSetting": "51.1429ch"
              }
            }
          ],
          "filter": true,
          "sortBy": [
            {
              "itemKey": "TimeGenerated",
              "sortOrder": 2
            }
          ],
          "labelSettings": [
            {
              "columnId": "UserName",
              "label": "User Name"
            },
            {
              "columnId": "Scope",
              "label": "Scope of role assignment"
            },
            {
              "columnId": "ResourceName",
              "label": "Name of the resource(group)"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "TimeGenerated",
            "sortOrder": 2
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Username",
        "comparison": "isNotEqualTo"
      },
      "name": "query - 0"
    },
    {
      "type": 1,
      "content": {
        "json": "\r\n## No role assignments for selected filters or Privileged Identity Management not enabled ##"
      },
      "conditionalVisibility": {
        "parameterName": "Username",
        "comparison": "isEqualTo"
      },
      "name": "text - 3"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}