{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "value::all"
              ],
              "parameters": [
                {
                  "id": "fa51b926-03c8-4151-a5ca-eae635c13d38",
                  "version": "KqlParameterItem/1.0",
                  "name": "SubscriptionPicker",
                  "label": "Subscription",
                  "type": 6,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "includeAll": true,
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all"
                },
                {
                  "id": "5e881044-d44c-4e32-b89a-45e39c0c7ae5",
                  "version": "KqlParameterItem/1.0",
                  "name": "WorkspacePicker",
                  "label": "Log Analytics Workspace",
                  "type": 5,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "where type =~ 'microsoft.operationalinsights/workspaces' \r\n| where (tostring(tags) has '\"[parameter(tagPrefix)]Purpose\":\"[parameter(tagValuePrefix)]Monitoring\"')\r\n| project id\r\n",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::1"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 2592000000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": [
                    "value::1"
                  ]
                },
                {
                  "id": "02858a2b-1143-4269-8cfa-2d5cdcdac0a8",
                  "version": "KqlParameterItem/1.0",
                  "name": "VM",
                  "label": "Virtual Machines",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "Resources\r\n| where type == \"microsoft.compute/virtualmachines\"\r\n| where tolower(tostring(tags)) !has '\"databricks-instance-name\"'\r\n| distinct name",
                  "crossComponentResources": [
                    "{SubscriptionPicker}"
                  ],
                  "isHiddenWhenLocked": true,
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "defaultValue": "value::all",
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                }
              ],
              "style": "above",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters - 0"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| summarize arg_max(ScanDate, *) by Computer\r\n| join kind=inner (\r\n    Heartbeat \r\n    | summarize arg_max(TimeGenerated, *) by Computer\r\n) on SourceComputerId\r\n| extend OS = iff(isempty(OSName),OSType,OSName)\r\n| project ScanDate, Computer, _ResourceId, SubscriptionId, TypeofProtection, ProtectionStatus, OS, AMProductVersion, SignatureVersion\r\n| where \"{SubscriptionPicker}\" contains tostring(SubscriptionId)\r\n| where \"{VM}\" contains tostring(Computer)\r\n| project-away ScanDate\r\n| sort by Computer asc\r\n| project-away Computer\r\n",
              "size": 1,
              "title": "VM's protection status",
              "noDataMessage": "No VM's found for selected log analytics workspace and subscription(s)",
              "timeContext": {
                "durationMs": 86400000
              },
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{WorkspacePicker}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SubscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "resid",
                    "formatter": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "_ResourceId",
                    "label": "VM"
                  },
                  {
                    "columnId": "SubscriptionId",
                    "label": "Subscription"
                  }
                ]
              }
            },
            "name": "query - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where ProtectionStatusRank !in (150, 550, 470)\r\n| where \"{SubscriptionPicker}\" contains tostring(SubscriptionId)\r\n| where \"{VM}\" contains tostring(Computer)\r\n| summarize (TimeGenerated, _ResourceId, SubscriptionId, ProtectionStatus, ProtectionStatusDetails, ProtectionStatusRank) = argmax(TimeGenerated, _ResourceId, SubscriptionId, ProtectionStatus, ProtectionStatusDetails, ProtectionStatusRank) by Computer\r\n| sort by Computer asc\r\n| project VM = _ResourceId, Subscription = SubscriptionId, ProtectionStatus, TimeGenerated, ProtectionStatusDetails, ProtectionStatusRank\r\n",
              "size": 1,
              "title": "VM's with Antimalware status needing attention",
              "noDataMessage": "No VM's with Antimalware status needing attention found for selected log analytics workspace and subscription(s)",
              "timeContext": {
                "durationMs": 86400000
              },
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{WorkspacePicker}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Subscription",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "TimeGenerated",
                    "formatter": 6,
                    "dateFormat": {
                      "showUtcTime": null,
                      "formatName": "shortDateTimePattern"
                    }
                  }
                ]
              }
            },
            "name": "query - 2"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "securityresources\r\n  | where type =~ 'microsoft.security/locations/alerts'\r\n  | where properties.SystemAlertId contains 'Antimalware Action Taken' or properties.AlertDisplayName contains 'Antimalware Action Taken' or properties.ResourceIdentifiers contains 'Antimalware Action Taken'\r\n  | where properties.Status in ('Active')\r\n  | where properties.Severity in ('Low', 'Medium', 'High')\r\n  | extend AzResourceId = split(properties.ResourceIdentifiers[1].AzureResourceId, '/')\r\n  | extend VMId = tostring(AzResourceId[(-1)])\r\n  | sort by tostring(properties.SystemAlertId) asc\r\n  | project VM = VMId, Subscription = subscriptionId, AlertText = properties.AlertDisplayName, AlertTime = properties.StartTimeUtc, AlertUri = properties.AlertUri",
                    "size": 1,
                    "title": "Detected Antimalware Threats",
                    "noDataMessage": "No antimalware threats found for VM's in selected subscription(s)",
                    "showExportToExcel": true,
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{SubscriptionPicker}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Subscription",
                          "formatter": 15,
                          "formatOptions": {
                            "linkTarget": null,
                            "showIcon": true
                          }
                        },
                        {
                          "columnMatch": "AlertTime",
                          "formatter": 6,
                          "dateFormat": {
                            "showUtcTime": null,
                            "formatName": "shortDateTimePattern"
                          }
                        },
                        {
                          "columnMatch": "AlertUri",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "Url",
                            "linkLabel": "Click to open Alert details"
                          }
                        }
                      ]
                    }
                  },
                  "name": "query - 0"
                }
              ]
            },
            "name": "group - 1"
          }
        ]
      },
      "name": "group - 0"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}