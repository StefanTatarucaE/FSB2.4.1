# ITSM Parent module
Azure Bicep parent module to create the ITSM resources for the Eviden Landingzones for Azure solution.

## Description
This parent module calls several child modules in the modules folder and deploys several resources required for the ITSM solution in the MGMT subscription.

The following resources are created:
 - A resource group for all the resources.
 - A key vault for storing ITSM configuration secrets (ServiceNow authentication)
 - Function App for ITSM CMDB and ALERT events (Powershell code), with AppServicePlan and AppInsights
 - StorageAccounts (1 for each Function App) used with Function Apps for ITSM
 - Logic App for ITSM alerts
 - Logic App for ITSM CMDB events
 - Key vault access policies: permissions for Function Apps and Logic Apps to get ITSM configuration secrets
 - Existing Monitoring Action Group resource is redeployed with Logic App Receiver for itsm-alerts Logic App.

The logic app uses the system managed identity to authenticate. Below are the permissions needed by each logic app.

ITSM Alerts

**Subscription**
- Reader
- Virtual Machine Contributor

**Resource Group where Azure Function is present**
- Contributor

ITSM CMDB

**Subscription**
- Virtual Machine Contributor
- Log Analytics Contributor
- Monitoring Contributor

**Resource Group where Azure Function is present**
- Contributor

ITSM Function app listener

**Subscription**
- Reader
- Virtual Machine Contributor

### Naming convention module
To ensure & enforce the required naming convention, the helper naming module is used by all other child modules.
The names being generated by the naming module are the actual resource names which are used on the Azure platform.
The naming convention module is run in a previous stage of the pipeline. The output from the module is saved to a file and published as a pipeline artifact. In subsequent stages the artifact is downloaded and used by Bicep parent modules.

## Parent module overview
The parent module has been configured as follows:
1. First the output of the naming module is loaded via a variable.
1. The resource group that will hold all ITSM resources is defined next.
1. The key vault that will store all customer provided configuration items used by ITSM resources is defined next.
1. Then the storage account that is required for Function App is defined.
1. In the following section the Function App is defined: Function App for pwsh ITSM code (ITSM Listener)
1. Next two Logic Apps are defined: one for ITSM alerts and a second one for ITSM-CMDB dicovery events.
1. All Function Apps and Logic Apps need access to configuration secrets stored in key vault, so key vault access policy is added that grants permission for Function Apps and Logic Apps to secrets is defined.
1. Monitoring Action Group resource is redeployed with Logic App Receiver for itsm-alerts Logic App. Assumption is that this Action Group is already existing: deployed at earlier stage for the monitoring solution (monitoring is a prerequisite for itsm integration).

### Parent module parameters

**Required parameters**

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `snowTenantCode` | `string` | Name of the Functional Organization for the customer in ServiceNow. |
| `snowEnvironmentCode` | `string` | Name of the Enviroment code for ServiceNow, must math an existing environment |
| `snowEventCategories` | `string` | Default value of ServiceNow categories triplet (e.g. 'Cloud.ELZ.Azure') for trouble tickets in ServiceNow. |
| `snowSupportGroup` | `string` | Default value of support group for CI registrations. Can be an empty string. |
| `snowNativeEnable` | `string` | Enable Native servicenow support. If disabled, will support ATF implementation of ServiceNow. Can be TRUE or FALSE. |
| `snowNativeIncSupportGroup` | `string` | When using Native support, allow to specify the support group for incidents. can be an empty string for no support group. |
| `snowNativeUrls` | `string` | When using Native support, allow to specify the URLS of the ServiceNow instances for each environment. |
| `enableItsmAlerting` | `boolean` | This parameter indicates if the ITSM alerting logic-app should be enabled or not after deployment. |
| `enableItsmCmdb` | `boolean` | This parameter indicates if the ITSM CMDB logic-app should be enabled or not after deployment. |


**Optional parameters**

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `additionalItsmTags` | `object` | `{}` | A mapping of additional tags to assign to all resources related to ITSM integration. |

## Example parameters file
The required values for parameters are described in the following example of a parameters file.
The values mentioned in this example are **not** default and **must** be defined for the parent module to run successfully.

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "additionalItsmTags": {
            "value": {}
        },
        "snowTenantCode": {
            "value": "Eviden Cloud ELZ-Azure"
        },
        "snowEventCategories": {
            "value": "Cloud.IaaS.ELZ-Azure"
        },
        "snowEnvironmentCode": {
          "value": "DEV"
        }
    }
}

```

## ELZ Azure Configuration Values

The parentModule folder (where the itsm.bicep file resides) contains a `parentModuleConfig.json` file. This json file holds the default configuration for deployment of ITSM related resources. The values from the json file map to parameters of storageAccount, functionApp and keyVault child modules.

Furthermore the parentModule folder contains the following files: `evgs-logic-network.json`, `evgs-logic-osmgmt.json`, `evgs-logic-paas-p1.json` & `evgs-logic-paas-p2.json`. These files contain the configuration for the eventgrid subscription used for the ITSM (CMDB) Logical app.

The `parentModuleConfig.json` file is referenced by the itsm parent module by declaring a 'parentModuleConfig' variable; `var parentModuleConfig = loadJsonContent('parentModuleConfig.json')`.

In the following table the configuration defaults within the `parentModuleConfig.json` file are described.

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `storageAccountKind` | `string` | `StorageV2` | Microsofts recommends `StorageV2` for storage accounts. The default configuration follows this recommendation. |
| `storageAccountSku` | `string` | `Standard_LRS` | The blobs saved on this container -tbd-, there is no need for extra redundancy. This is why the sku is set to `Standard_LRS`. |
| `storageAccountAccessTier` | `string` | `Hot` | Blobs on this storage account need to be available immediately at runtime. So, the default is set to `Hot`. |
| `storageAccountAllowBlobPublicAccess` | `bool` | `false` | As a default `public access` to Blobs is not allowed. |
| `storageAccountNetworkAcls` | `object` | `{"bypass": "AzureServices, Logging, Metrics", "defaultAction": "Allow", "ipRules": []}` | The ELZ default configuration for access to the storage account via network is as follows: `AzureServices, Logging & Metrics` will bypass any restrictions. The default action when no other rules match is to `Allow` the traffic. No `IP addresses` are set as allowed in the storage account firewall. |
| `storageAccountChangeFeed` | `object` | `{"enabled": true, "retentionInDays": 7}`| It is best practice to enable `change feed` to track changes (on blobs & blob metadata). ELZ default is to set the logging to 7 days.|
| `storageAccountBlobSvcDeleteRetentionPolicy` | `object` | `{"enabled": true, "retentionInDays": 7}` | default is to `retain` deleted blobs for 7 days. |
| `itsmListenerAppServicePlanKind` | `string` | `FunctionApp` | Hosting Plan Kind. Must be 'FunctionApp', because function itsm listener is pwsh code that runs on Windows ASP. |
| `itsmListenerAppServiceKind` | `string` | `functionapp` | App Service kind. App Service uses the value of the kind property to specialize the UX of a Microsoft.Web\Sites resource in the Azure Portal. `'functionapp'` defines it as Function Code App for pwsh code function itsm listener. |
| `itsmListenerAppServiceProperties` | `array` | `[{"name":"FUNCTIONS_EXTENSION_VERSION","value":"~4"},{"name":"FUNCTIONS_WORKER_RUNTIME","value":"powershell"},{"name":"FUNCTIONS_WORKER_RUNTIME_VERSION","value":"7.2"},{"name":"PSWorkerInProcConcurrencyUpperBound","value":"5"},{"name":"CFG_SECRET_NAME","value":"global-monitoring-snow-event"},{"name":"CFG_SNOW_URLS","value":"{\"PROD\":\"https://atosglobal.service-now.com\",\"CAT\":\"https://atosglobalcat.service-now.com\",\"DEV\":\"https://atosglobaldev.service-now.com\",\"SAND\":\"https://atosglobalsandbox.service-now.com\"}"},{"name":"WEBSITE_RUN_FROM_PACKAGE","value":"1"},{"name":"DEBUG","value":"FALSE"},{"name":"CFG_DEFAULT_INC_CRITICALITY","value":"warning"},{"name":"CFG_DEFAULT_INC_TYPE","value":"availability"},{"name":"CFG_DEFAULT_INC_MONITORING_TOOL","value":"ATF-AZURE"},{"name":"CFG_DEFAULT_INC_CAT_SUFFIX","value":""},{"name":"CFG_CMDB_ENABLE_CI_CREATION","value":"TRUE"},{"name":"CFG_DEFAULT_CMDB_CI_CRITICALITY","value":"medium"},{"name":"CFG_NATIVE_SECRET_NAME","value":"native-monitoring-snow-event"},{"name":"CFG_CMDB_VM_CI_VMINSTANCE_NAME_SUFFIX","value":""},{"name":"CFG_CMDB_VM_CI_SERVER_NAME_SUFFIX","value":"-VSR"},{"name":"CFG_CMDB_CI_VMINSTANCE_MODELID","value":"00_Virtual_Machine_Instance_Generic_Product"},{"name":"CFG_CMDB_CI_VMSERVER_MODELID","value":"00_Virtual_Machine_Instance_Generic_Product"},{"name":"CFG_CMDB_CI_APPSERVICEPLAN_MODELID","value":"00_Application_Generic_Product"},		{"name":"CFG_CMDB_CI_APPSERVICE_MODELID","value":"00_Application_Generic_Product"},{"name":"CFG_CMDB_CI_BASTION_MODELID","value":"00_Application_Generic_Product"},{"name":"CFG_CMDB_CI_ANALYSISSVC_MODELID","value":"00_Application_Generic_Product"},{"name":"CFG_CMDB_CI_APPGATEWAY_MODELID","value":"00_Load_Balancer_Applications_Generic_Product"},{"name":"CFG_CMDB_CI_LOADBALANCER_MODELID","value":"00_Load_Balancer_Applications_Generic_Product"},{"name":"CFG_CMDB_CI_CONTAINEREGISTRY_MODELID","value":"00_Generic_Storage_Container_Product"},{"name":"CFG_CMDB_CI_STORAGEACCOUNT_MODELID","value":"00_Generic_Storage_Container_Product"},{"name":"CFG_CMDB_CI_KEYVAULT_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_REDISCACHE_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_COSMOSDB_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_MARIADB_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_MYSQLDB_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_POSTGRESQLDB_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_DATABRICKS_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_DATAFACTORY_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_SQLDB_MODELID","value":"00_Database_Generic_Product"},{"name":"CFG_CMDB_CI_SQLSRVDB_MODELID","value":"00_Database_Instance_Generic_Product"},{"name":"CFG_CMDB_CI_K8CLUSTER_MODELID","value":""},{"name":"CFG_CMDB_CI_NSG_MODELID","value":"00_Network_Gear_Generic_Product"},{"name":"CFG_CMDB_CI_FIREWALL_MODELID","value":"00_Network_Gear_Generic_Product"},{"name":"CFG_CMDB_CI_VIRTUALNETGATEWAY_MODELID","value":"00_Network_Gear_Generic_Product"},{"name":"CFG_CMDB_CI_EXPRESSROUTE_MODELID","value":"00_Network_Gear_Generic_Product"}]`| Function App settings. Array of elements with required key and value pair for itsm-cmdb Function App runtime environment variables. |
| `itsmListenerAppServiceSiteConfig` | `object` | `{"http20Enabled": true, "minTlsVersion": "1.2", "ftpsState": "FtpsOnly", "powerShellVersion": "7.2"}` | App Service Site Config object. Includes `"powerShellVersion": "7.2"` for running pwsh code and other configuration values for recommended security settings. |
| `appInsightsKind` | `string` | `web` | App Insights Kind (possible values: web, ios, other, store, java, phone). 'web' for Function Apps. |
| `appInsightsProperties` | `object` | `{"Request_Source": "IbizaWebAppExtensionCreate"}` | App Insights properties. Object of elements. Request_Source describes what tool created this Application Insights component. `"Request_Source":"IbizaWebAppExtensionCreate"` for Function apps. |
| `appServicePlanSku` | `object` | `{"name": "Y1", "tier": "Dynamic"}` | Hosting Plan SKU object (name and tier). See Microsoft documentation for choosing the right SKU. For function consumption plan set to `{"name":"Y1", "tier":"Dynamic"}`.|
| `appServiceClientAffinityEnabled` | `bool` | `false` | App Service Client Affinity enabled. Set to false as best practice for stateless functions. |
| `appServiceHttpsOnly` | `bool` | `true` | App Service Https Only. Set to true as best practice. |
| `appServiceClientCertEnabled` | `bool` | `false` | App Service Client certificate enabled. Set to false as ITSM Function Apps do not use it. |
| `keyVaultSkuName` | `string` | `standard` | Specifies the SKU name for the key vault. Valid options are premium or standard. ELZ does not use HSM-protected keys of Premium tier, so Standard SKU. |
| `keyVaultFeatures` | `object` | `{ "enabledForDeployment":false, "enabledForDiskEncryption":false, "enabledForTemplateDeployment":false, "enablePurgeProtection":false, "enableRbacAuthorization":false, "enableSoftDelete":true }` | Object to specify key vault features. |
| `keyVaultSoftDeleteRetentionInDays` | `int` | `7` | Number of retention days for soft delete, if the Soft Delete feature is enabled (in keyVaultFeatures). Ignored if Soft Delete is not enabled. Default is to retain deleted secrets for 7 days. |
| `keyVaultPublicNetworkAccess` | `string` | `enabled` | Specifies whether the key vault will accept traffic from public internet. If set to disabled it overrides all firewall rules, allowing only private endpoint and trusted services traffic. For customer ITSM key vault it needs to be `enabled` as customer provided secrets are to be added manually after deployment. |
| `keyVaultNetworkRuleBypassOptions` | `string` | `AzureServices` | Specifies what traffic can bypass the network rules. This can be `AzureServices` or `None`. For ITSM integration Azure services (Function app) access the key vault. |
| `keyVaultNetworkRuleAction` | `string` | `Allow` | The default action when no rule from ipRules and from virtualNetworkRules match is to `Allow` traffic. This is only used after the bypass (keyVaultNetworkRuleBypassOptions) property has been evaluated. |

In the following table the configuration defaults within the `evgs-logic-network.json` file are described.

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `resourceType` | `string` | `Microsoft.Logic/workflows` | The eventgrid subscription resourcetype. |
| `functionName` | `string` | `` | The function name. |
| `advancedFilters` | `array` | `[{ "operator": "StringBeginsWith", "key": "data.operationName","Values": ["Microsoft.Network/applicationGateways/delete", "Microsoft.Network/applicationGateways/write", "Microsoft.Network/loadBalancers/write", "Microsoft.Network/loadBalancers/delete", "Microsoft.Network/networkSecurityGroups/write", "Microsoft.Network/networkSecurityGroups/delete", "Microsoft.Network/azureFirewalls/write", "Microsoft.Network/azureFirewalls/delete", "Microsoft.Network/virtualNetworkGateways/write", "Microsoft.Network/virtualNetworkGateways/delete", "Microsoft.Network/expressRouteCircuits/write", "Microsoft.Network/expressRouteCircuits/delete"]}]` | Holds the data.operationName & data.authorization.action filter for the eventgrid subscription |
| `includedEventType` | `array` | `["Microsoft.Resources.ResourceDeleteSuccess","Microsoft.Resources.ResourceWriteSuccess", "Microsoft.Resources.ResourceActionSuccess"]` | Holds the event type filter for the eventgrid subscription |

In the following table the configuration defaults within the `evgs-logic-osmgmt.json` file are described.
| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `resourceType` | `string` | `Microsoft.Logic/workflows` | The eventgrid subscription resourcetype. |
| `functionName` | `string` | `` | The function name. |
| `advancedFilters` | `array` | `[{ "operator": "StringBeginsWith", "key": "data.operationName", "Values": ["Microsoft.Compute/virtualMachines/write", "Microsoft.Compute/virtualMachines/delete", "Microsoft.Compute/virtualMachines/start/action", "Microsoft.Compute/virtualMachines/stop/action", "Microsoft.Compute/virtualMachines/deallocate/action","Microsoft.Compute/virtualMachineScaleSets/write", "Microsoft.Compute/virtualMachineScaleSets/delete", "Microsoft.Compute/virtualMachineScaleSets/start/action", "Microsoft.Compute/virtualMachineScaleSets/stop/action","Microsoft.Compute/virtualMachineScaleSets/deallocate/action","Microsoft.ContainerService/managedClusters/write","Microsoft.ContainerService/managedClusters/delete"]}]` | Holds the data.operationName & data.authorization.action filter for the eventgrid subscription |
| `includedEventType` | `array` | `["Microsoft.Resources.ResourceDeleteSuccess", "Microsoft.Resources.ResourceWriteSuccess", "Microsoft.Resources.ResourceActionSuccess"]` | Holds the event type filter for the eventgrid subscription |

In the following table the configuration defaults within the `evgs-logic-paas-p1.json` file are described.
| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `resourceType` | `string` | `Microsoft.Logic/workflows` | The eventgrid subscription resourcetype. |
| `functionName` | `string` | `` | The function name. |
| `advancedFilters` | `array` | `[{ "operator": "StringBeginsWith", "key": "data.operationName", "Values": ["Microsoft.Web/serverfarms/Delete", "Microsoft.Web/serverfarms/Write","Microsoft.Web/sites/Write", "Microsoft.Web/sites/Delete", "Microsoft.Storage/storageAccounts/write", "Microsoft.Storage/storageAccounts/delete", "Microsoft.Sql/servers/write", "Microsoft.Sql/servers/delete", "Microsoft.Sql/servers/databases/write", "Microsoft.Sql/servers/databases/delete", "Microsoft.Sql/managedInstances/write", "Microsoft.Sql/managedInstances/delete", "Microsoft.Sql/managedInstances/databases/write","Microsoft.Sql/managedInstances/databases/delete", "Microsoft.SqlVirtualMachine/SqlVirtualMachines/write", "Microsoft.SqlVirtualMachine/SqlVirtualMachines/delete", "Microsoft.Cache/Redis/write", "Microsoft.Cache/Redis/Delete", "Microsoft.DocumentDB/databaseAccounts/write", "Microsoft.DocumentDB/databaseAccounts/delete"]}` | Holds the data.operationName & data.authorization.action filter for the eventgrid subscription |
| `includedEventType` | `array` | `["Microsoft.Resources.ResourceDeleteSuccess", "Microsoft.Resources.ResourceWriteSuccess", "Microsoft.Resources.ResourceActionSuccess"]` | Holds the event type filter for the eventgrid subscription |

In the following table the configuration defaults within the `evgs-logic-paas-p2.json` file are described.
| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `resourceType` | `string` | `Microsoft.Logic/workflows` | The eventgrid subscription resourcetype. |
| `functionName` | `string` | `` | The function name. |
| `advancedFilters` | `array` | `[{ "operator": "StringBeginsWith", "key": "data.operationName", "Values": ["Microsoft.ContainerService/managedClusters/write", "Microsoft.ContainerService/managedClusters/delete", "Microsoft.DBforMariaDB/servers/write", "Microsoft.DBforMariaDB/servers/delete", "Microsoft.DBforPostgreSQL/servers/write", "Microsoft.DBforPostgreSQL/servers/delete", "Microsoft.DBforMySQL/servers/write", "Microsoft.DBforMySQL/servers/delete", "Microsoft.ContainerRegistry/registries/write", "Microsoft.ContainerRegistry/registries/delete", "Microsoft.KeyVault/vaults/write", "Microsoft.KeyVault/vaults/delete", "Microsoft.Databricks/workspaces/write", "Microsoft.Databricks/workspaces/delete", "Microsoft.DataFactory/factories/write","Microsoft.DataFactory/factories/delete", "Microsoft.AnalysisServices/servers/write", "Microsoft.AnalysisServices/servers/delete", "Microsoft.Network/bastionHosts/write", "Microsoft.Network/bastionHosts/delete"]}` | Holds the data.operationName & data.authorization.action filter for the eventgrid subscription |
| `includedEventType` | `array` | `["Microsoft.Resources.ResourceDeleteSuccess", "Microsoft.Resources.ResourceWriteSuccess", "Microsoft.Resources.ResourceActionSuccess"]` | Holds the event type filter for the eventgrid subscription |


> **Note**
> 
> It is recommended to only change these values after consulting the ELZ for Azure engineering team.

## Outputs
| Name | Description | Value
| --- | --- | --- |
| `itsmResourceGroupName` | The name of the deployed resource group. | `itsmResourceGroup.name` |
| `itsmKeyVaultName` | The name of the deployed key vault for storing ITSM configuration secrets. | `itsmKeyVault.outputs.keyVaultName` |
| `itsmAlertsLogicAppResourceId` | The resource Id of the deployed Logic App for ITSM-alerts events. | `itsmAlertsLogicApp.outputs.logicAppID` |
| `itsmCmdbLogicAppResourceId` | The resource Id of the deployed Logic App for ITSM-cmdb events. | `itsmCmdbLogicApp.outputs.logicAppID` |