# Monitoring Parent module
Azure Bicep parent module to create the monitoring resources for the Eviden Landingzones for Azure solution.

## Description
This parent module calls several child modules in the modules folder and deploys several resources required for the monitoring solution in the customer subscriptions.

The following resources are created in the MANAGEMENT subscription for CORE, NETWORK, OS-MGMT and PAAS:

- A resource group for all the resources
- A Log Analytics workspace
- Action group (with empty action, will be updated later by the ITSM module)
- Log analytics alerts
- Service and Resource Health alerts
- Policies for diagnostic settings
- Policy for Azure Defender export
- User assigned managed identity for the monitoring agent

The following resources are created in the MANAGEMENT subscription for OS-MGMT only :

- Data collection rules (DCR)

The following resources are created in the CONNECTIVITY and LANDING ZONES subscriptions for CORE, NETWORK, OS-MGMT and PAAS:

- A resource group for all the resources
- Service and Resource Health alerts
- Policies for diagnostic settings
- Policy for Azure Defender export
- User assigned managed identity for the monitoring agent

### Naming convention module
To ensure & enforce the required naming convention, the helper Naming module is used by all other child modules.
The names being generated by the naming module are the actual resource names which are used on the Azure platform.
The naming convention module is run in a previous stage of the pipeline. The output from the module is saved to a file and published as a pipeline artifact. In subsequent stages the artifact is downloaded and used by Bicep parent modules.

### Note about dataRetentionDefault value

The diagnosticrules for EvidenManaged resources are configured to send resource & activity logs to the log analytics workspace. Not every resource usage scenario can be predicted. As a consequence of that it's impossible to estimate the cost for Log Analytics Workspace ingestion and Log Analytics Workspace retention.

Make sure to implement budget Alerts using the cost management module to use as an early warning method to be informed about unexpected costs related to data ingestion and subsequently data retention.

The "dataRetentionDefault" is the setting which is used for indicating the "interactive retention time" period. This is the period in which the data can be used for interactive queries (reports, alerts). One can override this "interactive retention time" per table and one can also set an archival retention period in case logs need to be archived longer but are actually not needed for interactive queries.

Read more about the difference between "interactive retention" & archival retention: https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-retention-archive?tabs=portal-1%2Cportal-2

Overriding the global interactive retention time and setting an archival retention time per table can be done by populating the "setRetentionDays" array in the monitoring's input file.


### Parent module overview
The parent module has been configured as follows.
1. The output of the naming module is loaded via variables.
2. The Components are deployed using the following conditions and logic, depending of the pipeline context :

| Component | Subscriptions | Scopes |
| --- | --- | --- |
| Resource group | MGMT, CNTY, LNDZ, TOOL | CORE |
| Log Analytics Workspace | MGMT | CORE |
| Action group | MGMT | CORE |
| Log analytics alerts | MGMT | CORE, NETWORK, OS-MGMT, PAAS |
| Service Heath alerts | MGMT, CNTY, LNDZ, TOOL | CORE |
| Resource Heath alerts | MGMT, CNTY, LNDZ, TOOL | CORE, NETWORK, OS-MGMT, PAAS |
| Diagnostic rules | MGMT, CNTY, LNDZ, TOOL | CORE, NETWORK, OS-MGMT, PAAS |
| Defender export policy | MGMT, CNTY, LNDZ, TOOL | CORE |

### Parent module parameters

**Required parameters**

| Parameter Name | Type | Description |
| :-- | :-- | :-- |
| `deploymentScope` | `string` | Deployment scope for this parent module. Can be 'core', 'network',  'osmgmt', 'paas'. To be provided by the pipeline |
| `subscriptionType` | `string` | Specify the type of subscription using abbreviation. Can be 'mgmt', 'cnty', 'lndz', 'tool'. To be provided by the pipeline |
| `managementSubscriptionId` | `string` | The Id of the management subscription. To be provided by the pipeline. |
| `managementSubscriptionId` | `string` | The Id of the manage ment subscription. To be provided by the pipeline. |
| `dataRetentionDefault` | `int` | The workspace data retention in days. Increasing the value increases the cost.|
| `monitoringWorkspaceSkuName` | `string` | Defines The name of the SKU. |

**Optional parameters**

| Parameter Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `additionalMonitoringTags` | `object` | `{}` | A mapping of additional tags to assign to the resource group. |
| `callerServicePrincipalAppId` | `string` | `n/z` | The ApplicationID of the service principal that runs the GitHub action workflow. |

## ELZ Azure Configuration Values

The parentModule folder (where the monitoring.bicep file resides) contains a `parentModuleConfig.json` file. This json file holds the default configuration for the monitoring solution deployment.

The `parentModuleConfig.json` file is referenced by the Monitoring parent module by declaring a 'parentModuleConfig' variable; `var parentModuleConfig = loadJsonContent('parentModuleConfig.json')`.

In the following table the configuration defaults are described.

| Name | Type | Default Value | Description |
| :-- | :-- | :-- | :-- |
| `monitoringWorkspacePublicNetworkAccess` | `object` | `{"forIngestion": "Enabled", "forQuery": "Enabled"       }` | The network access type for operating on the Workspace. |
| `dataSources` | `array` | refer to parentModuleConfig | Array to specify the Datasources to add to the Workspace. If you need to enable collection of informational event logs, the parentModuleConfig.json file needs to be edited. Please read the how-to guides from wiki article: https://docs.cloud.eviden.com/02.%20Eviden%20Landing%20Zones/02.%20AZURE/02.-Release-2.3/01.-DevSecOps/02.-How-To-Guides/03.-Configure/004-Create-and-Configure-Workflows-Parameters/ |
| `solutions` | `array` | see parentModuleConfig, too long to add | Array to specify the Solutions to add to the Workspace. |
| `dataCollectionRules` | `array` | see parentModuleConfig, too long to add | Array to specify the data collection rules used by the Azure monitoring agents. Warning: it needs to be aligned with names defined in the naming module.|


> **Note**
>
> It is recommended to only change these values after consulting the ELZ for Azure engineering team.

## Example parameters file
The required values for parameters are described in the following example of a parameters file.
The values mentioned in this example are **not** default and **must** be defined for the parent module to run successfully.

```
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "additionalMonitoringTags": {
      "value": {}
    },
    "monitoringWorkspaceSkuName": {
      "value": "PerGB2018"
    },
    "dataRetentionDefault": {
      "value": 31
    }
  }
}
```
## Child modules parameters
For a full list of all available parameters and variables, please refer to the child module readme files and the bicep files.

## Log analytics alerts JSON repository

All log alerts are stored in JSON files named "logAnalyticsAlerts.<SCOPE>.json" in the monitoring module folder,
separated in different files for each scope (core, network, osmgmt, paas ...).
Due to some limitations in JSON file size for BICEP, the PAAS file is splitted in two files.

The JSON object for each alert is listed in the following table: 

| Name | Description | Example value
| --- | --- | --- |
| `alertName` | Specifies the name of the alert rule. |Example test alert|
| `alertDescription` | Specifies the description of the alert rule. |Cloud.PaaS.DCS-Azure-Management - Part of standard set of log alerts|
| `alertSeverity` | Specify the Severity number of the alert.<ul><li>0: Critical</li><li>1: Error</li><li>2: warning</li><li>3: Informational</li><li>4: verbose</li></ul>|2|
| `query` | Log analytics query rule in Kusto language |AzureActivity|top 1 by TimeGenerated desc|summarize AggregatedValue=count() by bin(TimeGenerated,5m)|
| `windowSize` | Period of time used to monitor alert activity based on the threshold. Must be between one minute and one day.  |30|
| `evaluationFrequency` | how often the metric alert is evaluated represented in ISO 8601 duration format. Example value is `PT5M` |30|
| `operator` | Operator comparing the current value with the threshold value.|GreaterThan|
| `threshold` | The threshold value at which the alert is activated.  |0|
| `metricColumn`| The name of the metric column for metric data alerts. Optional, can be empty string |ResourceID|
| `metricThresholdOperator` | The name of the threshold operator for metric data alerts. Optional, can be empty string |GreaterThan|
| `metricThreshold` | The value of the threshold for metric data type |0|
| `metricTriggerType` | The name of the threshold trigger type for metric data alerts. Optional, can be empty string |Consecutive|
| `enableAlert` | Specifiy if the alert will be enabled or disabled. Optional, default is enabled |0|
| `autoMitigate` | Specifies if the alert should be configured to resolve automatically by Azure Monitor. Optional, default is disabled (false) |0|

## Outputs

| Name | Description | Value
| --- | --- | --- |
| `monitoringResourceGroupName` | The name of the deployed resource group. | `monitoringResourceGroup.name` |
| `monitoringWorkspaceName` | The name of the deployed monitoring Log Analytics Workspace. | `workspaceName` |
| `monitoringWorkspaceResourceId` | The resource Id of the deployed monitoring Log Analytics Workspace. | `workspaceResourceID` |
| `actionGroupResourceId` | The resource Id of the deployed monitoring Action group. | `actionGroupResourceID` |

Note :

### Missing security (critical and non-critical) updates alert not supported for Linux

Update Management collects records for Windows and Linux VMs. A record with a type of Update is created that represents updates available and their installation status for a machine. As per Microsoft documentation 'PublishedDate' is the date when the update is ready to be downloaded and installed from Windows Update. This date is always blank (null) in case of Linux VM. There is no reference to decide period of missing updates in case of Linux if 'PublishedDate' is null. This is known issue from Microsoft. Check [this document](https://learn.microsoft.com/en-us/azure/automation/update-management/query-logs#query-update-record)  for reference.